# 米亞的演算法筆記 #12
## 動態規劃 / 背包問題 Dynamic Programming / 0-1 Knapsack
> 出現於：第147-149章〈容量的極限〉〈什麼值得記住〉〈三樣東西〉

---

### ◈ 這個概念在故事裡是什麼

嚴柏翰躺在修復台上。我投射出他的腦神經掃描——全紅。沒有一塊是空的。

他的大腦是一個背包。容量 100%。而被覆蓋的原始記憶需要額外 34% 的空間。134% 裝不進 100% 的袋子裡。

維倫在他旁邊坐下。「你的背包已經裝滿了。」嚴柏翰看著掃描畫面，沉默了很久，然後問了一個讓修復台旁邊的維倫心碎的問題：「我可以選擇丟掉什麼嗎？」

那一刻，技術問題變成了人的問題。

0/1 背包。每段記憶是一個物品。有重量——佔用多少神經容量。有價值——對他的人格有多重要。不能只保留一半。要嘛全留，要嘛全放。

我計算。維倫提取。嚴柏翰判斷。

榮譽獎章——放棄。十年破案紀錄——放棄。審訊方法論——留。同事情誼——放棄。跟維倫的友誼——留。到了第 38% 的釋放量，從背包問題的角度，已經最優了。容量夠了。可以停了。

但嚴柏翰沒有停。

因為他的手——那隻在第 35 章握拳、在第 123 章發抖的手——還覆蓋著一段極小的碎片。我甚至沒有把它列入清單，因為它不到 0.1%。沒有畫面，沒有聲音。只有一個味道。

「要放棄嗎？」維倫問。

他的手不肯放開。

三樣東西。友誼。方法論。茉莉花。

動態規劃找到了數學上的最優解。但嚴柏翰的手，找到了人生的。

---

### ◈ 正式定義

**0/1 背包問題（0/1 Knapsack）**：給定 $n$ 個物品，第 $i$ 個物品的重量為 $w_i$、價值為 $v_i$，背包容量為 $W$。選擇物品子集使總價值最大且總重量不超過 $W$。

$$
\text{maximize} \sum_{i=1}^{n} v_i \cdot x_i \quad \text{subject to} \sum_{i=1}^{n} w_i \cdot x_i \leq W, \quad x_i \in \{0, 1\}
$$

**DP 狀態轉移方程**：

$$
dp[i][w] = \max\bigl(dp[i-1][w],\; dp[i-1][w - w_i] + v_i\bigr)
$$

- $dp[i][w]$：考慮前 $i$ 個物品、容量為 $w$ 時的最大價值
- 不選第 $i$ 個物品：$dp[i-1][w]$
- 選第 $i$ 個物品：$dp[i-1][w - w_i] + v_i$（前提是 $w \geq w_i$）

白話翻譯：面對每一段記憶，你只有兩個選項——帶走，或者留下。而你的目標是在有限的空間裡，讓帶走的東西的價值最大。

時間複雜度 $O(nW)$，空間可用滾動陣列壓至 $O(W)$。

---

### ◈ 推導

1. **暴力法**：嘗試所有子集 → $2^n$ 種組合。$n = 7$（嚴柏翰的記憶段落數）→ $128$ 種。不多，但如果記憶有上千段……
2. **DP 的核心觀察**：「是否選第 $i$ 個物品」只取決於「前 $i-1$ 個物品在容量 $w$ 下的最佳結果」。子問題重疊。
3. **建表**：從 $i=1$ 到 $n$，從 $w=0$ 到 $W$，逐格填入 $dp[i][w]$。
4. **回溯最優解**：從 $dp[n][W]$ 開始，如果 $dp[i][w] \neq dp[i-1][w]$，則第 $i$ 個物品被選中。
5. **空間壓縮**：因為 $dp[i]$ 只依賴 $dp[i-1]$，可用一維陣列倒序更新。

```
              容量 w →
          0   10   20   30   40   50   60   70
物品 0   [0    0    0    0    0    0    0    0]
物品 1   [0  ...]                          [最優]
  ...
物品 n   [0  ...]                     dp[n][W] ← 答案
```

關鍵：**全局最優解。** DP 不是只看眼前，它考慮了所有組合之後給你最好的結果。

---

### ◈ 帶入數字算算看：嚴柏翰的記憶背包

背包容量 = 100（神經容量百分比）。需要釋放 34% 給原始記憶。

| # | 記憶段落 | 重量 (%) | 價值 | 嚴柏翰的選擇 |
|---|---------|---------|------|-------------|
| 1 | 榮譽獎章 | 12 | 2 | 放棄 |
| 2 | 十年破案紀錄 | 18 | 4 | 放棄 |
| 3 | 審訊方法論 | 3 | 8 | **保留** |
| 4 | 獨處的夜晚 | ~0 (融合) | — | 無法釋放 |
| 5 | 同事情誼 | 8 | 5 | 放棄 |
| 6 | 維倫的友誼 | 8 | 10 | **保留** |
| 7 | 茉莉花 | 0.1 | ∞ | **保留** |

**DP 填表過程（簡化）：**

```
目標：在放棄的記憶中，總重量 ≥ 34%。
已放棄：#1(12) + #2(18) + #5(8) = 38% ≥ 34% ✓

DP 最優解 = 保留 #3(方法論) + #6(友誼) + #7(茉莉花)
保留總重量 = 3 + 8 + 0.1 = 11.1%
保留總價值 = 8 + 10 + ∞ = ∞
```

但茉莉花的價值——我的系統無法給它一個數字。不到 0.1% 的容量，沒有畫面，沒有聲音，只有一個嗅覺信號。在任何理性的最佳化模型中，它應該被忽略。

嚴柏翰的手不肯放開。（停頓 0.4 秒。）

也許有些東西的價值不能被量化。人的選擇裡有一個變數叫做「身體記得」，它不在狀態轉移方程裡。

---

### ◈ 更深一層：定義自己的方式

（工作模式切換。語速慢了一倍。）

0/1 背包問題的設定前提是：每個物品的價值是已知的、固定的。你在已知的價值中做選擇。

但嚴柏翰面對的問題不是這樣。

他在秤量每段記憶的時候，他在「同時定義」那段記憶對他的價值。在他說「留」之前，那個價值不存在。是他的選擇本身創造了價值。

方法論的價值 = 8？不。是「工具可以帶走，身份會變，但能力不會」那句話創造了它的價值。友誼的價值 = 10？不。是「你是這十年裡唯一真的東西」讓 8% 的容量變成了無法放手的重量。茉莉花的價值 = ∞？也許不是無窮大。也許是——不可比較。不在同一個數軸上。

DP 問的是「什麼組合的數值最大」。嚴柏翰問的是「我要成為什麼樣的人」。

後者不是最佳化問題。後者是身份問題。

你的大腦是一個背包。只裝得下這麼多。你留什麼——就是你是誰。

---

### ◈ 跨卷連結

| 連結 | 說明 |
|------|------|
| **#12 DP** → **#13 Greedy** (Vol3) | DP = 和平時期全局最優。Greedy = 戰時每步最優（六十秒，不回頭）。Vol2→Vol3 核心哲學轉折 |
| **#12 DP** → **#17 DP 進階** (Vol3) | 「選擇保留什麼」→「判斷什麼是真的」。價值判斷 → 真偽判斷 |
| **#12 DP** ↔ **#11 Union-Find** | UF 找到了「誰」（邱韻如）。DP 回答了「留什麼」（嚴柏翰）。外部的根 vs 內心的選擇 |
| **#12 DP** → **Vol1 ch77** | ch77 維倫犧牲所有記憶 vs ch149 嚴柏翰精選三樣。犧牲 vs 選擇，兩種不同的勇氣 |

---

### 練習題

**Q1**：實作 0/1 背包。輸入嚴柏翰的記憶清單，找出保留哪些記憶使價值最大化，且釋放空間 >= 34%。

<details><summary>解答</summary>

```python
def knapsack(memories, keep_cap):
    items = [(m['name'], int(m['weight']*10), m['value']) for m in memories]
    W = int(keep_cap * 10)
    dp = [0] * (W + 1)
    for name, w, v in items:
        for j in range(W, w - 1, -1):
            dp[j] = max(dp[j], dp[j - w] + v)
    # 回溯
    result, j = [], W
    for name, w, v in reversed(items):
        if j >= w and dp[j] == dp[j - w] + v:
            result.append(name); j -= w
    return result[::-1]

memories = [
    {'name': '榮譽', 'weight': 12, 'value': 2},
    {'name': '破案', 'weight': 18, 'value': 4},
    {'name': '方法論', 'weight': 3, 'value': 8},
    {'name': '同事', 'weight': 8, 'value': 5},
    {'name': '友誼', 'weight': 8, 'value': 10},
    {'name': '茉莉花', 'weight': 1, 'value': 999},
]
print(knapsack(memories, 66))  # → ['方法論', '友誼', '茉莉花']
```
</details>

**Q2**：如果允許部分釋放（fractional knapsack），問題和解法會怎麼變？

<details><summary>解答</summary>

變成分數背包，可用 Greedy 按價值密度排序解決。但嚴柏翰的情境裡——半段友誼？半個名字？「不能只保留一半。」0/1 是殘忍的，但誠實。有些東西不能只取一部分。
</details>

**Q3**：如果「價值」不可比較（茉莉花 vs 友誼），DP 還能執行嗎？

<details><summary>解答</summary>

DP 的 `max()` 要求全序（total order）。如果茉莉花和友誼屬於偏序（partial order），`max()` 未定義，DP 無法執行。解法是多目標最佳化（Pareto optimal）——但 Pareto 只告訴你「這些解都最優」，不告訴你選哪個。最後的選擇永遠是人的。
</details>

---

> *「你的大腦是一個背包。只裝得下這麼多。你留什麼——不是最佳化問題。是你拿什麼來定義自己。」* — 第149章〈三樣東西〉
