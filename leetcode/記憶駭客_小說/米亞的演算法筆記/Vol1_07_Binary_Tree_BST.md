# 米亞的演算法筆記 #07
## 二元樹與二元搜尋樹 Binary Tree / BST
> 出現於：第85章〈深潛協議〉、第88章〈分岔〉、第93章〈沉默的鋼琴師〉、第94章〈根與葉〉

---

### ◈ 這個概念在故事裡是什麼

第85章。維倫第一次踏入地下實驗室——周明哲留下的原型深潛機。我掃描了核心程式碼，發現它跟我的基底架構有 34% 的重疊。建造我的人，也建造了這台機器。

牆上有一塊白板，墨水乾了十年。我在上面畫出了深潛空間的基本結構：一棵倒長的巨樹。根在最深處——是一個人的核心身份、最重要的動機。枝幹向上生長，是長期記憶。枝葉是日常碎片、感官殘留。維倫盯著那張圖看了很久。然後他說：「所以身體記憶在根部。」

是的。大多數記憶篡改者只會修剪枝葉。但有人——學會了砍根。

第93章。鋼琴師李曼筠走進工作室。她的手指在微微發抖。她用了所有的力氣說了一個字：「彈。」她不能彈了。我投射她的記憶結構——根斷了。斷面像鏡子一樣光滑。數位手術刀，精確到奈米等級。有人故意切斷了她的技能之根。但枝葉還在風中搖晃。她還記得蕭邦夜曲讓她想起祖母。她只是不記得怎麼彈了。

第94章。維倫深潛進她的記憶空間——不是迷宮，是一片森林。巨樹站在中心。他用 BST 的搜尋邏輯定位切口的精確位置：比「日常練琴」更深，比「比賽失誤」更淺。切口在「第一次觸鍵的記憶」和「祖母教她音階」之間。只殺才華，不殺感情。能做到這件事的人，必須先完整掃描過這棵樹。

---

### ◈ 正式定義

**Binary Tree（二元樹）**：每個節點最多有兩個子節點（左、右）的樹形結構。

$$\text{若樹有 } n \text{ 個節點，則恰有 } n - 1 \text{ 條邊。}$$

**Binary Search Tree（BST）**：一種特殊的二元樹，滿足 BST 性質：

$$\forall \text{ 節點 } x: \text{左子樹所有值} < x.\text{val} < \text{右子樹所有值}$$

白話翻譯：左邊的都比你小，右邊的都比你大。每一個節點都是一道分界線。

**三種走訪方式**：
- **Inorder（中序）**：左 → 根 → 右。BST 的中序走訪 = 排序結果
- **Preorder（前序）**：根 → 左 → 右。先處理自己，再處理子代
- **Postorder（後序）**：左 → 右 → 根。先處理子代，再處理自己

---

### ◈ 推導

BST 搜尋的時間複雜度，從第一原理出發。

平衡 BST 的高度為 $h = O(\log n)$。每次搜尋從根出發，沿一條路徑向下：

$$T(n) = T\!\left(\frac{n}{2}\right) + O(1)$$

解遞迴：$T(n) = O(\log n)$。

但如果樹退化為鏈（每個節點只有一個子節點），高度 $h = n$，搜尋退化為 $O(n)$。

```
平衡 BST:            退化 BST:
      4                 1
     / \                 \
    2   6                 2
   / \ / \                 \
  1  3 5  7                 3
                             \
                              4
h = log₂(n)            h = n
```

這就是為什麼「結構」很重要。同樣的資料，不同的排列，效率天差地別。

```python
class TreeNode:
    def __init__(self, val, left=None, right=None):
        self.val = val
        self.left = left
        self.right = right

def bst_search(root, target):
    """BST 搜尋：每步排除一半子樹"""
    if root is None:
        return None
    if target == root.val:
        return root
    elif target < root.val:
        return bst_search(root.left, target)   # 往左
    else:
        return bst_search(root.right, target)   # 往右

def inorder(root):
    """中序走訪 → 排序結果"""
    if root is None:
        return []
    return inorder(root.left) + [root.val] + inorder(root.right)
```

---

### ◈ 帶入數字算算看：鋼琴師的記憶之樹

第94章。李曼筠的記憶之樹有大約 $n = 127$ 個核心節點（$2^7 - 1$，深度 7 的完滿二元樹）。

根節點：**「為什麼彈琴」**——她四歲時祖母第一次把她的手放在琴鍵上。

| 深度 | 節點數 | 記憶層級 | 範例 |
|------|--------|---------|------|
| 0（根）| 1 | 核心動機 | 「為什麼彈琴」 |
| 1 | 2 | 基礎技能 | 左：音階感覺 / 右：節拍感覺 |
| 2 | 4 | 進階技能 | 和弦、踏板、指法、呼吸 |
| 3 | 8 | 曲目記憶 | 蕭邦、貝多芬、德布西... |
| 4 | 16 | 表演經歷 | 比賽、音樂會、練習室... |
| 5 | 32 | 情感連結 | 祖母、老師、掌聲、失誤... |
| 6 | 64 | 日常碎片 | 琴蓋的溫度、譜架的角度... |

維倫用 BST 搜尋切口位置：

1. 根節點「為什麼彈琴」→ 完好。往下
2. 深度 1 左「音階感覺」→ **斷裂**。切口在這裡到根之間
3. 但深度 1 右「節拍感覺」→ 完好。所以不是根被砍——是根與左子樹的連結被切斷

搜尋步數：$\lceil \log_2 127 \rceil = 7$ 步，定位精確切口。

結論：切割者精準地斷開了「技能起源」和「情感起源」之間的連結。只殺才華，不殺感情。

---

### ◈ 更深一層：根是「為什麼」

三種走訪，三種理解一個人的方式。

**Preorder（前序）**：先看根——先問「你為什麼做這件事」，再看你怎麼做。這是維倫修復記憶的方式。他總是先找動機。

**Inorder（中序）**：從小到大排列——按時間線走過一個人的一生。這是嚴柏翰在 ch33 的 Binary Search 用的方式。

**Postorder（後序）**：先看葉子，最後才碰根——從表面記憶開始剝，一層一層，直到碰到最深處。這是記憶篡改者的手法。他們從外圍開始修剪，讓你以為一切正常。等你發現根被動了，已經太晚了。

第88章，維倫在議員記憶迷宮的分岔路口看到了 BST 的結構：左子樹是「做了的事」，右子樹是「沒做的事」。每一個節點都是一次選擇。整棵樹就是一個人的人生——所有做過的選擇，和所有放棄的可能性。

「根不是技能。根是『為什麼』。」

如果根被修改了，整棵樹都變了。你以為你在修剪枝葉，但改變的是根——你就不再是你了。這是鋼琴師案最恐怖的地方：她還記得音樂讓她感受到什麼，但她不知道自己為什麼愛音樂。切割者偷走的不是能力，是意義。

---

### ◈ 跨卷連結

| 本卷使用 | 跨卷回收 | 連結方式 |
|---------|---------|---------|
| ch85 記憶之樹結構 | Vol 2-4 所有深潛場景 | 樹形結構成為深潛空間的基礎視覺語言 |
| ch88 BST 分岔 | Vol 2 ch100 三方勢力圖 (Graph) | 從「二元選擇」擴展到「多方網絡」 |
| ch93 根被砍斷 | Vol 3 ch215 語青碎片回溯 (Backtracking) | 「砍根」vs「找回根」的對稱 |
| ch94 BST 精準定位 | Vol 4 ch305 最終深潛修復 | 維倫修復的最後一棵樹，根節點標籤是「愛」 |

**前置概念**：Linked List（樹是鏈結的擴展：一對多）、Array（排序概念）
**後續概念**：DFS / BFS（樹的走訪 → 圖的搜索）、Trie（樹的特化版本）、Heap（完全二元樹）

---

### 練習題

**Q1**：一棵有 $n = 15$ 個節點的完滿 BST，搜尋任何目標最多需要幾步？

<details><summary>答案</summary>

$h = \log_2(15 + 1) = 4$。完滿二元樹 $n = 2^h - 1$，高度 $h = 4$，最多比較 4 次。

</details>

**Q2**：BST 的中序走訪結果為 `[1, 3, 5, 7, 9, 11, 13]`，請畫出這棵 BST（假設平衡）。根節點是什麼？

<details><summary>答案</summary>

根 = 7（中位數）。左子樹 = {1, 3, 5}，右子樹 = {9, 11, 13}。

```
        7
       / \
      3   11
     / \ / \
    1  5 9  13
```

</details>

**Q3**：在鋼琴師的記憶之樹中，如果篡改者不是切斷「根與左子樹的連結」，而是直接修改根節點的值（把「為什麼彈琴」改成「為什麼恨音樂」），會發生什麼？

<details><summary>答案</summary>

BST 性質會崩潰。根的值決定了左右子樹的分界——如果根被替換，所有的搜尋結果都會錯位。在故事中，這意味著：她不只是「不會彈了」，而是「她的整個人生敘事都被重寫了」——所有原本基於「愛音樂」做出的選擇，都會被重新詮釋為基於「恨音樂」。這比切斷連結更可怕。維倫在第94章說的那句話：「你以為你在修剪枝葉，但改變的是根。」

</details>

---

> *「一棵樹被砍了，但根還在地下。只要找到根，它會重新長。問題是——如果有人換了根呢？長出來的，還是同一棵樹嗎？根不是技能。根是『為什麼』。失去技能可以重學。失去『為什麼』——你連重學的理由都沒有了。」*
> — 第94章〈根與葉〉
