# 電子學（七）：差動放大器

## 🔰 本章基礎觀念（零基礎必讀）

### 什麼是差動放大器？

到目前為止，我們分析的放大器都是**單端輸入**（一個信號端加一個地端）。但在現實世界中，信號常常伴隨著雜訊。

**差動放大器（Differential Amplifier）**的核心功能：**只放大兩個輸入之間的「差異」，拒絕兩個輸入上共同存在的雜訊。**

> **白話比喻**：想像你在嘈雜的餐廳裡，兩隻耳朵同時聽到環境噪音（共模雜訊），但只有一邊能聽到朋友說話（差模信號）。你的大腦會自動忽略環境噪音，只處理朋友的聲音——這就是差動放大器在做的事！

### 為什麼差動放大器如此重要？

1. **運算放大器（Op-Amp）的核心**就是差動放大器
2. 抗雜訊能力強（共模拒斥）
3. 可以消除偶次諧波失真
4. 是所有高精度類比電路的基礎

---

## 一、差動放大器的基本結構

### 1.1 MOSFET 差動對

兩個完全相同的 NMOS（M1、M2）：
- 源極共接，透過一個**尾電流源 ISS** 接地
- 閘極分別接兩個輸入 v1 和 v2
- 汲極分別接負載（RD 或主動負載）

**關鍵條件**：M1 = M2（完全匹配），RD1 = RD2

### 1.2 BJT 差動對

兩個完全相同的 NPN BJT（Q1、Q2）：
- 射極共接，透過尾電流源 IEE 接地
- 基極分別接兩個輸入
- 集極分別接負載 RC

**原理完全相同**，只是用 BJT 代替 MOSFET。

---

## 二、差模與共模

### 2.1 定義

給定兩個輸入 v1 和 v2：

**差模輸入（Differential Mode Input）**：
$$v_d = v_1 - v_2$$

**共模輸入（Common Mode Input）**：
$$v_{cm} = \frac{v_1 + v_2}{2}$$

反過來：
$$v_1 = v_{cm} + \frac{v_d}{2}, \quad v_2 = v_{cm} - \frac{v_d}{2}$$

### 2.2 直覺理解

| 情況 | v1 | v2 | vd | vcm | 意義 |
|------|----|----|-----|-----|------|
| 純差模 | +0.5mV | -0.5mV | 1mV | 0 | 有用信號 |
| 純共模 | +1V | +1V | 0 | 1V | 雜訊/偏移 |
| 混合 | +1.5V | +0.5V | 1V | 1V | 實際情況 |

### 數值例題 7.1：差模與共模分解

> **題目**：v1 = 2.6V，v2 = 2.4V。求差模和共模輸入。
>
> **解答**：
> vd = v1 - v2 = 2.6 - 2.4 = **0.2V**
> vcm = (v1 + v2)/2 = (2.6 + 2.4)/2 = **2.5V**
>
> 驗證：v1 = 2.5 + 0.1 = 2.6V ✓，v2 = 2.5 - 0.1 = 2.4V ✓

---

## 三、差模增益 Ad

### 3.1 MOSFET 差動對的差模分析

純差模輸入時（vcm = 0，v1 = vd/2，v2 = -vd/2）：

由對稱性，**尾電流源節點電壓不變**（虛地，Virtual Ground）。

因此每半邊等效為一個獨立的 CS 放大器：

**差動輸出（vo = vo1 - vo2）**：

$$A_d = \frac{v_o}{v_d} = -g_m(R_D \| r_o)$$

若只看單端輸出（vo1 或 vo2）：

$$A_d = \frac{v_{o1}}{v_d} = -\frac{1}{2}g_m(R_D \| r_o)$$

### 3.2 BJT 差動對的差模增益

同理：

$$A_d = -g_m(R_C \| r_o) \quad (\text{差動輸出})$$

$$A_d = -\frac{1}{2}g_m(R_C \| r_o) \quad (\text{單端輸出})$$

### 數值例題 7.2：差模增益計算（MOSFET）

> **題目**：MOSFET 差動對，ISS = 0.4mA，kn'(W/L) = 2mA/V²，RD = 10kΩ，λ = 0。
> 求差模增益（差動輸出和單端輸出）。
>
> **解答**：
> 每管電流：ID = ISS/2 = 0.2mA
>
> gm = √(2kn'(W/L)ID) = √(2 × 2m × 0.2m) = √(0.8m²) = 0.894 mS
>
> 差動輸出增益：Ad = -gm × RD = -0.894m × 10k = **-8.94**
> 單端輸出增益：Ad = -½ × 0.894m × 10k = **-4.47**

### 數值例題 7.3：差模增益計算（BJT）

> **題目**：BJT 差動對，IEE = 1mA，β = 200，RC = 10kΩ，VA = ∞。
> 求差模增益（差動輸出）。
>
> **解答**：
> 每管電流：IC ≈ IEE/2 = 0.5mA
>
> gm = IC/VT = 0.5m/0.026 = 19.23 mS
>
> Ad = -gm × RC = -19.23m × 10k = **-192.3**
>
> **比較**：相同電流下 BJT 的差模增益遠大於 MOSFET（gm 更大）。

---

## 四、共模增益 Ac

### 4.1 共模分析

純共模輸入時（vd = 0，v1 = v2 = vcm）：

由對稱性，兩管電流變化完全相同。尾電流源節點電壓會改變。

**如果尾電流源是理想的（RSS = ∞）**：ISS 不變，電流不變，共模增益 = 0！

**如果尾電流源有有限輸出電阻 RSS**：

$$A_c = \frac{-R_D}{2R_{SS} + \frac{1}{g_m}} \approx \frac{-R_D}{2R_{SS}} \quad (\text{單端輸出})$$

差動輸出的共模增益：
$$A_c^{diff} = 0 \quad (\text{理想匹配時！})$$

> **重要結論**：差動輸出的共模增益在理想匹配下為零！這是差動放大器的最大優勢。

### 數值例題 7.4：共模增益和 CMRR

> **題目**：MOSFET 差動對，gm = 2mS，RD = 10kΩ，尾電流源輸出電阻 RSS = 500kΩ。
> 求共模增益（單端）和 CMRR。
>
> **解答**：
> 差模增益（單端）：Ad = -½gmRD = -½ × 2m × 10k = -10
>
> 共模增益（單端）：
> Ac ≈ -RD/(2RSS) = -10k/(2 × 500k) = -0.01
>
> CMRR = |Ad/Ac| = 10/0.01 = **1000 = 60 dB**
>
> **結果**：差模信號被放大 10 倍，共模信號只被放大 0.01 倍。

---

## 五、共模抑制比（CMRR）

### 5.1 定義

$$CMRR = \left|\frac{A_d}{A_c}\right|$$

通常以 dB 表示：

$$CMRR_{dB} = 20\log_{10}(CMRR)$$

### 5.2 CMRR 與尾電流源的關係

**單端輸出**：
$$CMRR = g_m R_{SS}$$

**提高 CMRR 的方法**：
1. 增大尾電流源的輸出電阻 RSS（用 Cascode 電流源）
2. 使用差動輸出（理想匹配下 CMRR = ∞）
3. 提高元件匹配度

### 5.3 實際的 CMRR 限制

即使用差動輸出，由於 M1 和 M2 不可能完美匹配（gm1 ≠ gm2、RD1 ≠ RD2），實際的差動輸出仍有非零的共模增益。

---

## 六、尾電流源的影響

### 6.1 理想電流源 vs 電阻

| 尾端元件 | RSS | CMRR | 評價 |
|---------|-----|------|------|
| 電阻 RE | RE | 低 | 最差 |
| 簡單電流鏡 | ro ≈ VA/I | 中 | 一般 |
| Cascode 電流鏡 | gm·ro² | **高** | 最好 |

### 6.2 為什麼不直接用大電阻？

用電阻做尾端需要很大的電壓降（VR = ISS × R），浪費電壓裕度。電流源可以用很小的 VDS 提供很大的 RSS。

### 數值例題 7.5：不同尾端的 CMRR 比較

> **題目**：gm = 2mS，RD = 10kΩ。比較以下三種尾端的 CMRR（單端輸出）：
> (a) 電阻 RSS = 10kΩ
> (b) 簡單電流鏡 RSS = 200kΩ
> (c) Cascode 電流鏡 RSS = 10MΩ
>
> **解答**：
> CMRR = gm × RSS
>
> (a) CMRR = 2m × 10k = 20 → **26 dB**
> (b) CMRR = 2m × 200k = 400 → **52 dB**
> (c) CMRR = 2m × 10M = 20000 → **86 dB**
>
> **結論**：Cascode 電流源大幅提高 CMRR。

---

## 七、單端輸出 vs 差動輸出

### 7.1 差動輸出

$$v_o = v_{o1} - v_{o2}$$

- 差模增益 = gm × RD（完整增益）
- 共模增益 = 0（理想匹配）
- **CMRR 最高**
- 缺點：需要差動到單端轉換電路

### 7.2 單端輸出

只取 vo1 或 vo2 其中一個。

- 差模增益 = ½gm × RD（少了一半）
- 共模增益 ≠ 0
- CMRR 有限
- 優點：電路簡單

### 7.3 主動負載差動對（重要！）

用 PMOS 電流鏡做負載，可以將差動對的差動信號轉成單端輸出，**同時保留完整的差模增益**。

**電路**：
- M1、M2：NMOS 差動對
- M3、M4：PMOS 電流鏡負載（M3 為二極體連接，M4 為鏡像管）

**工作原理**：
- M1 的電流變化 Δi 被 M3 吸收
- M3 鏡像到 M4，M4 的電流也變化 Δi
- 在 M2/M4 的汲極交會處：M4 輸出 +Δi，M2 吸收 -Δi
- 總電流變化 = 2Δi → **增益加倍回完整差模增益**

$$A_d = -g_{m1}(r_{o2} \| r_{o4})$$

### 數值例題 7.6：主動負載差動對

> **題目**：NMOS 差動對 + PMOS 電流鏡負載。
> ISS = 0.2mA，gm1 = gm2 = 1mS，ro2 = 200kΩ，ro4 = 300kΩ。
> 求差模增益（單端輸出）。
>
> **解答**：
> Ad = -gm(ro2 ∥ ro4)
> = -1m × (200k ∥ 300k)
> = -1m × 120k
> = **-120**
>
> 對比被動電阻負載（如 RD = 10kΩ）的單端增益：
> Ad = -½ × 1m × 10k = -5
>
> **主動負載增益提高了 24 倍！**

---

## 八、失調電壓（Offset Voltage）

### 8.1 什麼是失調電壓？

理想情況下，v1 = v2 時，vo = 0。但實際上，由於 M1、M2 不完美匹配，即使 v1 = v2，輸出也不是零。

**輸入參考失調電壓 VOS**：需要在輸入加上 VOS 才能使輸出為零。

### 8.2 失調的來源

1. **Vth 不匹配**（ΔVth）：主要因素
2. **(W/L) 不匹配**（Δ(W/L)/(W/L)）
3. **RD 不匹配**（ΔRD/RD）
4. **ISS 的影響較小**

$$V_{OS} \approx \Delta V_{th} + \frac{V_{OV}}{2}\left[\frac{\Delta(W/L)}{(W/L)} + \frac{\Delta R_D}{R_D}\right]$$

### 8.3 降低失調的方法

1. **增大元件尺寸**（提高匹配度）
2. **減小 VOV**（減弱 W/L 不匹配的影響）
3. **版圖匹配技術**（共質心佈局 Common-centroid layout）

### 數值例題 7.7：失調電壓估算

> **題目**：差動對，ΔVth = 2mV，VOV = 0.2V，Δ(W/L)/(W/L) = 1%，RD 完美匹配。
> 估算 VOS。
>
> **解答**：
> VOS = ΔVth + (VOV/2) × Δ(W/L)/(W/L)
> = 2mV + (0.2/2) × 0.01
> = 2mV + 1mV
> = **3 mV**

---

## 九、差動放大器的大信號特性

### 9.1 MOSFET 差動對的大信號轉移特性

當差模輸入 vd 很大時，尾電流完全流向一側：

- |vd| < √2 × VOV：兩管都導通，線性放大區
- |vd| > √2 × VOV：一管截止，另一管承載全部電流

**線性範圍**：差動對的線性輸入範圍 ≈ ±√2 × VOV

### 9.2 BJT 差動對的大信號特性

$$\frac{I_{C1}}{I_{C2}} = e^{v_d/V_T}$$

BJT 的線性範圍更窄（約 ±2VT ≈ ±52mV），但在線性範圍內的增益更高。

### 數值例題 7.8：線性範圍比較

> **題目**：比較 MOSFET（VOV = 0.2V）和 BJT 差動對的線性輸入範圍。
>
> **解答**：
> MOSFET：±√2 × VOV = ±0.283V ≈ **±283 mV**
> BJT：約 ±2VT = **±52 mV**
>
> **結論**：MOSFET 差動對的線性範圍是 BJT 的 5 倍以上，但代價是增益較低。

---

## 關鍵術語表

| 中文 | 英文 | 白話解釋 | 例子 |
|------|------|---------|------|
| 差動放大器 | Differential Amplifier | 放大兩輸入之差，拒絕共同雜訊 | OPA 的輸入級 |
| 差模 | Differential Mode (DM) | 兩輸入的差異 | vd = v1 - v2 |
| 共模 | Common Mode (CM) | 兩輸入的平均值 | vcm = (v1+v2)/2 |
| 差模增益 | Differential Gain (Ad) | 對差模信號的放大倍數 | 我們想要的 |
| 共模增益 | Common Mode Gain (Ac) | 對共模信號的放大倍數 | 越小越好 |
| CMRR | Common Mode Rejection Ratio | Ad/Ac，衡量拒絕共模的能力 | 越大越好（>60dB） |
| 尾電流源 | Tail Current Source (ISS) | 提供恆定總電流的電流源 | 決定 CMRR |
| 主動負載 | Active Load | PMOS 電流鏡做負載 | 提高增益 |
| 失調電壓 | Offset Voltage (VOS) | 匹配不完美導致的等效輸入誤差 | 典型 1~10 mV |
| 半電路 | Half-circuit | 利用對稱性只分析一半的技巧 | 簡化分析 |
| 虛地 | Virtual Ground | 差模分析時尾端不動的性質 | 簡化為 CS |

---

## 題型鑑別

| 看到什麼條件 | 用什麼方法 |
|-------------|-----------|
| 「差動對、求差模增益」 | 用半電路分析，Ad = -gm(RD∥ro) |
| 「差動對、求共模增益」 | Ac ≈ -RD/(2RSS)（單端） |
| 「求 CMRR」 | CMRR = |Ad/Ac| = gm × RSS |
| 「主動負載差動對」 | Ad = -gm(ro2∥ro4)，差動轉單端 |
| 「失調電壓」 | VOS = ΔVth + (VOV/2)(Δ(W/L)/(W/L) + ΔRD/RD) |
| 「求線性範圍」 | MOSFET：±√2·VOV；BJT：±2VT |
| 「尾電流源影響」 | RSS 越大，CMRR 越高 |

---

## ✅ 自我檢測

### 概念題

1. 差動放大器的最大優勢是什麼？
2. 為什麼差動輸出的 CMRR 比單端輸出高？
3. 尾電流源的輸出電阻 RSS 對 CMRR 有什麼影響？
4. 主動負載差動對如何將差動信號轉為單端輸出？
5. 失調電壓 VOS 的主要來源是什麼？如何降低？

<details>
<summary>點擊查看答案</summary>

1. **能有效拒絕共模雜訊。** 差動放大器只放大兩個輸入之間的差異，而共同存在的雜訊被大幅抑制（由 CMRR 衡量）。

2. **因為理想匹配時，差動輸出的共模增益為零。** 共模信號使兩管產生相同的電流變化，因此 vo1 和 vo2 同相同幅變化，vo1 - vo2 = 0。

3. **RSS 越大，CMRR 越高。** CMRR(單端) = gm × RSS。因為更大的 RSS 意味著尾電流更不受共模輸入影響，共模增益更小。

4. **用 PMOS 電流鏡。** M3（二極體連接）吸收 M1 的電流變化並鏡像到 M4。M4 的電流變化和 M2 的電流變化方向相反，在輸出節點疊加，產生等於差動輸出的完整增益。

5. **主要來源是 Vth 不匹配（ΔVth）。** 降低方法：增大元件尺寸（改善匹配）、減小 VOV（減弱 W/L 不匹配影響）、使用共質心版圖佈局。

</details>

### 計算題

6. 差動對，ISS = 0.8mA，gm（每管）= 3mS，RD = 8kΩ。求差模增益（差動輸出和單端輸出）。
7. 上題，尾電流源 RSS = 1MΩ。求共模增益（單端）和 CMRR（dB）。
8. MOSFET 差動對 + PMOS 電流鏡負載，gm = 2mS，ron = rop = 100kΩ。求增益。
9. 差動對 VOV = 0.15V，ΔVth = 3mV，Δ(W/L)/(W/L) = 2%，ΔRD/RD = 0。求 VOS。

<details>
<summary>點擊查看答案</summary>

6. 差動輸出：Ad = -gm × RD = -3m × 8k = **-24**
   單端輸出：Ad = -½ × 3m × 8k = **-12**

7. Ac(單端) = -RD/(2RSS) = -8k/(2×1M) = -0.004
   CMRR = |Ad/Ac| = 12/0.004 = 3000
   CMRR(dB) = 20log(3000) = **69.5 dB**

8. Ad = -gm(ron∥rop) = -2m × (100k∥100k) = -2m × 50k = **-100**

9. VOS = 3mV + (0.15/2) × 0.02 = 3mV + 1.5mV = **4.5 mV**

</details>

---

> **下一篇**：[electronics_08_頻率響應](electronics_08_頻率響應.md) — 學習放大器在不同頻率下的行為！
