# VLSI 教學講義 第四章：動態邏輯與特殊電路

> **適用對象**：零基礎入門，電機/電子系大學部至研究所
> **重要度**：動態邏輯是高速 IC 設計的進階技術，I/O 電路是晶片與外界溝通的橋樑

---

## 🔰 本章基礎觀念（零基礎必讀）

### 靜態 CMOS 的局限

靜態 CMOS（上一章學的）有很多優點，但也有缺點：

| 缺點 | 原因 |
|------|------|
| 電晶體數量多 | 每個函數需要 PDN + PUN = 2N 個電晶體 |
| 輸入電容大 | 每個輸入連接 NMOS + PMOS 的閘極 |
| 速度受限 | PMOS 串聯（在 NOR 中）很慢 |

**動態邏輯的核心想法**：用**時脈控制的預充/求值**機制取代 PUN，減少電晶體數量和電容。

---

## 一、動態邏輯（Dynamic Logic）

### 1.1 基本結構

```
        VDD
         │
    ┌────┤
    │  ┌─┴─┐
 CLK────┤ Mp│    預充電晶體（PMOS）
    │  └─┬─┘    CLK = 0 時導通
    │    │
    │    ├──── Vout（動態節點）
    │    │
    │   PDN      NMOS 下拉網路（與靜態 CMOS 相同）
    │    │
    │  ┌─┴─┐
 CLK────┤ Me│    求值電晶體（NMOS）
    │  └─┬─┘    CLK = 1 時導通
    └────┤
         │
        GND
```

### 1.2 兩個工作階段

#### (a) 預充階段（Precharge Phase）：CLK = 0

```
操作：
1. Mp（PMOS）導通 → Vout 被充電到 VDD
2. Me（NMOS）截止 → PDN 斷開
3. 無論輸入是什麼，Vout 都被拉到 VDD
```

#### (b) 求值階段（Evaluate Phase）：CLK = 1

```
操作：
1. Mp（PMOS）截止 → 停止充電
2. Me（NMOS）導通 → PDN 連接到 GND
3. 如果 PDN 有導通路徑（F = 1）→ Vout 放電到 0
4. 如果 PDN 無導通路徑（F = 0）→ Vout 保持 VDD（靠電容儲存）
```

### 1.3 為什麼比靜態 CMOS 快？

| 優勢 | 說明 |
|------|------|
| 電晶體少 | 只需 PDN + 2（預充+求值）= N+2 個（vs 靜態的 2N） |
| 輸入電容小 | 每個輸入只連接 NMOS 閘極（無 PMOS） |
| 電容小 → 速度快 | 輸出節點電容較小 |
| 只有下降轉態 | Vout 只會從 VDD→0（不會 0→VDD），轉態時間確定 |

### 1.4 動態邏輯的問題

#### 問題 1：電荷分享（Charge Sharing）

```
        VDD
         │
        Mp
         │
         ├──── Vout (C_out)
         │
       ┌─┴─┐
     A─┤ N1│
       └─┬─┘
         │ ← C_x（內部節點的寄生電容）
       ┌─┴─┐
     B─┤ N2│
       └─┬─┘
         │
        Me
         │
        GND
```

**場景**：預充後 Vout = VDD，求值時 A = 1, B = 0：
- N1 導通，N2 截止
- Vout 上的電荷會與 C_x **分享**
- Vout 下降到 VDD × C_out / (C_out + C_x)
- 如果 C_x 夠大，Vout 可能被誤判為 Low！

**解決方案**：
1. 對內部節點也加預充電晶體
2. 增加弱 keeper（小 PMOS 維持電壓）
3. 讓 C_out >> C_x

#### 問題 2：漏電（Leakage）

動態節點靠電容儲存電荷，但漏電會讓電荷慢慢流失。

- 次閾值漏電可能在求值階段讓 Vout 錯誤放電
- **解決方案**：加 keeper（弱回饋 PMOS）或限制求值時間

#### 問題 3：時脈饋通（Clock Feedthrough）

時脈信號通過閘極-汲極的耦合電容影響動態節點電壓。

#### 問題 4：不能串接（Monotonicity 問題）

動態閘的輸出在預充後為 VDD，求值時只會**下降（不會上升）**。
如果下一級也是動態閘，它期待輸入只上升（0→1），但實際只下降（1→0）。

**這就引出了 Domino Logic！**

---

## 二、Domino Logic

### 2.1 結構：動態閘 + 靜態反相器

```
        VDD           VDD
         │              │
        Mp            ┌─┤
         │          ┌─┴─┐
         ├── Vdyn   │   │ ← 靜態反相器
         │          └─┬─┘
        PDN           │
         │            ├──── Vout
        Me            │
         │          ┌─┴─┐
        GND         │   │
                    └─┬─┘
                      │
                     GND
```

### 2.2 工作原理

| 階段 | Vdyn | Vout |
|------|------|------|
| 預充（CLK=0） | VDD | 0（經反相器） |
| 求值（F=0） | VDD（保持） | 0（保持） |
| 求值（F=1） | 0（放電） | VDD（經反相器） |

**關鍵觀察**：Vout 只會從 **0 → VDD（上升）**，不會下降！

### 2.3 為什麼 Domino 可以串接？

```
動態閘1 → INV → 動態閘2 → INV → 動態閘3 → INV → ...
```

- 預充時：所有 Vdyn = VDD，所有 Vout = 0
- 求值時：Vout 只會 0→VDD（**單調上升, Monotonic Rising**）
- 下一級動態閘的 PDN 只會被 0→1 的輸入驅動 → **不會錯誤放電**

> **Domino 就像骨牌**：一級一級地「倒下」（求值），只朝一個方向。

### 2.4 Domino 的優缺點

| 優點 | 缺點 |
|------|------|
| 速度快（電晶體少、電容小） | 只能實現**非反相**（Non-Inverting）函數 |
| 無 glitch（單調轉態） | 需要時脈分配 |
| 可串接多級 | 佔用時脈的一半週期（預充+求值） |
| 高扇入效能好 | 電荷分享問題仍存在 |
| | 不能用在 latch-based 設計中的某些拓撲 |

### 2.5 Domino 只能實現非反相函數

因為反相器已經加在輸出了：
- PDN 實現 F → Vdyn = $\overline{F}$ → Vout = F

所以 Domino 直接輸出 F（非反相），**不能直接輸出 $\overline{F}$**。

**如何解決？**
- 使用 DeMorgan 定律重寫函數
- 例：$\overline{A + B}$ = $\overline{A}$ · $\overline{B}$（用互補輸入的 AND）

### 2.6 Keeper 設計

為了解決電荷分享和漏電問題，加一個**弱 PMOS keeper**：

```
        VDD
         │
        Mp (預充)
         │
    ┌────┤──── Vdyn
    │    │
   weak  PDN
   PMOS  │
    │    Me
    │    │
    └────GND
         │
        GND

Keeper 的閘極接 Vout（反相器輸出）
```

- 當 Vout = 0（Vdyn 應該是 VDD）→ keeper PMOS 導通 → 維持 Vdyn = VDD
- keeper 要夠**弱**（小尺寸），否則會阻礙 PDN 放電

---

## 三、NP-CMOS / Zipper Logic

### 3.1 NP-CMOS（NORA Logic）

**想法**：交替使用 N-block（NMOS PDN）和 P-block（PMOS PUN），避免反相器。

```
     CLK = φ         CLK = φ_bar
 ┌───────────┐    ┌───────────┐
 │  N-block  │ ── │  P-block  │ ── ...
 │ (NMOS PDN)│    │ (PMOS PUN)│
 │ +預充PMOS │    │ +預充NMOS │
 └───────────┘    └───────────┘
```

**N-block**：
- CLK = 0：PMOS 預充到 VDD
- CLK = 1：NMOS PDN 求值（可能放電到 0）
- 輸出只下降（VDD → 0）

**P-block**：
- CLK = 1：NMOS 預充到 0
- CLK = 0：PMOS PUN 求值（可能充電到 VDD）
- 輸出只上升（0 → VDD）

**優點**：不需要反相器，可以實現反相函數
**缺點**：設計複雜，兩相時脈

### 3.2 Zipper Logic

Zipper Logic 是 NP-CMOS 的改良版本：
- 使用交疊時脈（Overlapping Clocks）
- 更好的時序控制
- 減少電荷分享問題

---

## 四、時脈產生電路

### 4.1 基本時脈需求

動態邏輯需要精確的時脈信號。常見需求：

| 類型 | 說明 |
|------|------|
| 單相時脈（Single Phase） | 一個 CLK 信號 |
| 兩相非重疊時脈（Two-Phase Non-Overlapping） | φ1 和 φ2，之間有間隙 |
| 互補時脈（Complementary） | CLK 和 CLK_bar |

### 4.2 兩相非重疊時脈產生

```
CLK ──→ ┌────┐      ┌────┐
         │NAND├──────┤ INV├──→ φ1
    ┌──→ │    │  ┌─→ │    │
    │    └────┘  │   └────┘
    │            │
    │    ┌────┐  │   ┌────┐
    │    │NAND├──┘   │ INV├──→ φ2
    └────┤    │ ←────┤    │
         └────┘      └────┘
         (交叉耦合)
```

**關鍵**：利用交叉耦合的 NAND 閘和延遲，確保 φ1 和 φ2 **永不同時為高**。

### 4.3 非重疊時間（Dead Time）

```
φ1  ┌────┐      ┌────┐
    │    │      │    │
────┘    └──────┘    └──────
            ↕
φ2      ┌────┐      ┌────┐
        │    │      │    │
────────┘    └──────┘    └──
         ←──→
      Dead Time（非重疊時間）
```

非重疊時間通常由延遲鏈控制，設計要考慮 PVT 變異。

---

## 五、I/O 電路

### 5.1 輸入保護（ESD Protection）

**ESD（Electrostatic Discharge，靜電放電）** 是 IC 的頭號殺手之一。

人體觸碰 IC 引腳時，可能產生 **數千伏特** 的靜電，足以擊穿閘極氧化層。

#### ESD 保護電路結構

```
     VDD
      │
    ┌─┴─┐
    │ D1│  上方保護二極體
    └─┬─┘
      │
PAD──┤──── R ────┤──── 內部電路
      │          │
    ┌─┴─┐      ═══ Cgate（內部閘極電容）
    │ D2│        │
    └─┬─┘       GND
      │
     GND
```

**工作原理**：
- 正常操作：二極體不導通，信號直接通過
- ESD 發生（電壓超過 VDD 或低於 GND）：二極體導通，將大電流導向電源軌
- 串聯電阻 R 限制電流

#### 常見 ESD 保護結構

| 結構 | 原理 | 保護等級 |
|------|------|---------|
| 二極體串聯 | PN 二極體箝位 | 基本 |
| RC-triggered NMOS | 大尺寸 NMOS 洩放 | 中等 |
| SCR（矽控整流器） | 利用寄生 BJT | 高（但較慢） |
| Snapback NMOS | NMOS 崩潰模式 | 高 |

> **ESD 保護標準**：
> - HBM（Human Body Model）：≥ 2kV
> - CDM（Charged Device Model）：≥ 500V
> - MM（Machine Model）：≥ 200V

### 5.2 輸出驅動器（Output Driver）

內部閘極驅動能力很弱，需要**緩衝器鏈**來驅動外部負載（通常是 pF 等級）。

#### 漸進式緩衝器鏈（Tapered Buffer Chain）

```
內部信號 → INV(×1) → INV(×4) → INV(×16) → INV(×64) → 外部負載
```

**最佳化**：每級放大倍率 ≈ e ≈ 2.72（理論最佳），實務常用 **3~4 倍**。

**級數計算**：

```
N = ln(CL / Cin) / ln(f)

其中 f 是每級放大倍率
```

#### 三態輸出（Tri-State Output）

```
        VDD
         │
    ┌────┤
EN──┤  ┌─┴─┐
    │  │ P │
 A──┤  └─┬─┘
    │    │
    │    ├──── PAD
    │    │
 A──┤  ┌─┴─┐
    │  │ N │
EN──┤  └─┬─┘
    └────┤
         │
        GND
```

| EN | A | PAD |
|----|---|-----|
| 0 | X | **高阻抗（Hi-Z）** |
| 1 | 0 | 0 |
| 1 | 1 | VDD |

### 5.3 位準轉換器（Level Shifter）

不同電壓域之間需要位準轉換：

**應用場景**：
- Core（0.9V）→ I/O（1.8V 或 3.3V）
- 低功率域 → 高功率域

#### 交叉耦合位準轉換器

```
       VDD_HIGH              VDD_HIGH
          │                     │
     ┌────┤                ┌────┤
     │  ┌─┴─┐            │  ┌─┴─┐
     │  │ P1├─────────────┤──┤ P2│
     │  └─┬─┘            │  └─┬─┘
     │    │               │    │
     │    ├── OUT          │    ├── OUT_bar
     │    │               │    │
     │  ┌─┴─┐            │  ┌─┴─┐
  IN─┤──┤ N1│    IN_bar──┤──┤ N2│
     │  └─┬─┘            │  └─┬─┘
     └────┤               └────┤
          │                     │
         GND                  GND
```

**工作原理**：
- IN = VDD_LOW（例如 0.9V）→ N1 導通，OUT 拉低
- 交叉耦合的 P1/P2 確保另一側拉高到 VDD_HIGH
- 輸出擺幅：0 到 VDD_HIGH

**問題**：如果 VDD_LOW 太小（比如 < 0.3V），N1 可能不夠強 → 需要特殊設計。

---

## 六、關鍵術語表

| 英文 | 中文 | 說明 |
|------|------|------|
| Dynamic Logic | 動態邏輯 | 用時脈控制預充/求值 |
| Precharge | 預充 | CLK=0 時，輸出充到 VDD |
| Evaluate | 求值 | CLK=1 時，PDN 決定輸出 |
| Charge Sharing | 電荷分享 | 內部電容分走輸出電荷 |
| Keeper | 保持器 | 弱 PMOS 維持電壓 |
| Domino Logic | 骨牌邏輯 | 動態閘 + 靜態反相器 |
| Monotonic | 單調 | 只朝一個方向變化 |
| NP-CMOS / NORA | NP 邏輯 | 交替 N-block 和 P-block |
| Zipper Logic | 拉鏈邏輯 | NP-CMOS 的改良版 |
| Non-Overlapping Clock | 非重疊時脈 | φ1 和 φ2 不同時為高 |
| ESD Protection | 靜電放電保護 | 防止靜電損壞 IC |
| Output Driver | 輸出驅動器 | 驅動外部負載 |
| Tri-State | 三態 | High/Low/Hi-Z |
| Level Shifter | 位準轉換器 | 不同電壓域轉換 |
| Tapered Buffer | 漸進式緩衝器 | 逐級放大驅動能力 |
| Clock Feedthrough | 時脈饋通 | 時脈透過寄生電容干擾 |
| HBM / CDM | 人體模型/元件充電模型 | ESD 測試標準 |
| SCR | 矽控整流器 | ESD 保護結構之一 |

---

## 七、數值例題

### 例題 1：動態邏輯電荷分享

**題目**：一個動態 2-input AND 閘（PDN = 2 個 NMOS 串聯），預充後 Vout = VDD = 1.0V。
輸出電容 C_out = 50 fF，內部節點寄生電容 C_x = 10 fF（預充前 C_x 上電壓 = 0V）。
求值時 A = 1, B = 0（只有 N1 導通）。
(a) Vout 會下降到多少？
(b) 若 VIL = 0.6V，是否會造成誤判？

**解答**：

(a) 電荷守恆（N1 導通，C_out 和 C_x 電荷分享）：

```
Q_before = C_out × VDD + C_x × 0
         = 50f × 1.0 + 10f × 0
         = 50 fC

Q_after = (C_out + C_x) × Vout_new

Vout_new = Q_before / (C_out + C_x)
         = 50f / (50f + 10f)
         = 50/60 × 1.0
         = 0.833V
```

(b) Vout 從 1.0V 下降到 0.833V。

```
Vout = 0.833V > VIL = 0.6V → 仍被判為 High → 不會誤判 ✓
```

但如果 C_x 更大，比如 C_x = 30 fF：
```
Vout = 50/(50+30) = 0.625V → 接近 VIL，很危險！
```

**答：(a) Vout = 0.833V (b) 不會誤判，但安全邊限不大**

---

### 例題 2：Domino 邏輯級數分析

**題目**：一個 4 級 Domino 邏輯鏈，每級的求值延遲 t_eval = 30 ps，反相器延遲 t_inv = 10 ps。
(a) 總延遲是多少？
(b) 如果時脈頻率 = 5 GHz，求值時間只有半週期，是否夠用？

**解答**：

(a) 每級 Domino = 動態閘 + 反相器
```
每級延遲 = t_eval + t_inv = 30 + 10 = 40 ps
4 級總延遲 = 4 × 40 = 160 ps
```

(b) 時脈週期 = 1/5GHz = 200 ps
求值時間 = 200/2 = 100 ps

```
160 ps > 100 ps → 不夠用！
```

需要減少級數或加快每級速度。

**答：(a) 160 ps (b) 不夠用，需最佳化**

---

### 例題 3：輸出驅動器設計

**題目**：內部閘極電容 Cin = 5 fF，外部負載 CL = 5 pF。
每級放大倍率 f = 4。
(a) 需要幾級緩衝器？
(b) 每級的尺寸（以 Cin 的倍數表示）？

**解答**：

(a)
```
N = ln(CL/Cin) / ln(f)
  = ln(5000fF / 5fF) / ln(4)
  = ln(1000) / ln(4)
  = 6.908 / 1.386
  ≈ 4.98 → 取 5 級
```

(b)
```
級 1: Cin × f⁰ = 5 fF × 1 = 5 fF
級 2: Cin × f¹ = 5 fF × 4 = 20 fF
級 3: Cin × f² = 5 fF × 16 = 80 fF
級 4: Cin × f³ = 5 fF × 64 = 320 fF
級 5: Cin × f⁴ = 5 fF × 256 = 1280 fF
```

驗證：級 5 能驅動 CL/f = 5000/4 = 1250 fF ≈ 1280 fF ✓

**答：(a) 5 級 (b) 尺寸比例為 1:4:16:64:256**

---

### 例題 4：位準轉換器功耗

**題目**：一個位準轉換器，將 0.8V 邏輯轉換為 1.8V 邏輯。
切換頻率 f = 500 MHz，輸出負載電容 CL = 20 fF，α = 0.3。
求動態功率。

**解答**：

位準轉換器的輸出擺幅是 0 到 VDD_HIGH = 1.8V。

```
Pdyn = α × CL × VDD_HIGH² × f
     = 0.3 × 20×10⁻¹⁵ × (1.8)² × 500×10⁶
     = 0.3 × 20×10⁻¹⁵ × 3.24 × 5×10⁸
     = 0.3 × 20 × 3.24 × 5 × 10⁻¹⁵⁺⁸
     = 0.3 × 324 × 10⁻⁷
     = 97.2 × 10⁻⁷
     = 9.72 μW
```

**答：Pdyn ≈ 9.72 μW**

---

## 八、題型鑑別表

| 題目特徵 | 題型 | 方法 |
|---------|------|------|
| 預充後電壓下降 | 電荷分享 | 電荷守恆 Q = CV |
| Domino 級數和延遲 | 時序分析 | 逐級加總延遲 |
| 驅動外部負載 | 緩衝器設計 | N = ln(CL/Cin)/ln(f) |
| 不同電壓域 | 位準轉換 | 交叉耦合結構分析 |
| ESD 保護 | I/O 設計 | 二極體/SCR 箝位 |
| 動態 vs 靜態比較 | 設計選擇 | 列出優缺點權衡 |

---

## ✅ 自我檢測

### Q1：動態邏輯比靜態 CMOS 快的主要原因是什麼？

<details>
<summary>點擊展開答案</summary>

三個主要原因：

1. **電晶體數量少**：只需 PDN + 2（預充+求值）= N+2 個，而靜態需要 2N 個。較少電晶體 → 較小的寄生電容。

2. **輸入電容小**：每個輸入只連接 NMOS 的閘極，不需連接 PMOS。輸入電容約減半。

3. **輸出電容小**：沒有 PUN 的擴散電容貢獻到輸出節點。

這些都使得 CL 更小，根據 tp = 0.69·R·CL，延遲更小。

此外，動態邏輯只有下降轉態（VDD→0），由較快的 NMOS 驅動，不需等待慢的 PMOS。
</details>

### Q2：Domino Logic 為什麼不能直接實現反相函數？如何解決？

<details>
<summary>點擊展開答案</summary>

**原因**：Domino 的結構是「動態閘（自然反相）+ 靜態反相器（再反相一次）」，兩次反相後輸出 = 原函數 F（非反相）。

如果要實現 $\overline{F}$，就需要再加一個反相器，但這個反相器的輸出會下降（VDD→0），下一級 Domino 期待輸入只上升 → **違反單調性** → 可能造成錯誤求值。

**解決方法**：
1. 用 DeMorgan 定律重寫函數，使所有閘都是非反相形式
   - 例：$\overline{A+B}$ = $\overline{A} \cdot \overline{B}$（用互補輸入做 AND）
2. 使用 NP-CMOS（交替 N-block 和 P-block）
3. 在需要的地方插入雙軌（Dual-Rail）邏輯
</details>

### Q3：為什麼 ESD 保護電路中的二極體不能太大？

<details>
<summary>點擊展開答案</summary>

二極體太大會帶來以下問題：

1. **寄生電容增大**：二極體的接面電容直接加在 I/O pad 上，增加輸入/輸出電容，降低信號速度，尤其在高頻應用（GHz 以上）中影響嚴重。

2. **漏電增加**：較大的二極體面積意味著更大的反向漏電流。

3. **面積成本**：ESD 保護電路已經佔 I/O 面積的大部分，更大的二極體會進一步增加面積。

設計 ESD 保護需要在**保護能力**和**性能損失**之間取得平衡。
</details>

### Q4：設計一個漸進式緩衝器鏈驅動 10 pF 的外部負載。內部 Cin = 2 fF，放大倍率 f = e ≈ 2.72。需要幾級？

<details>
<summary>點擊展開答案</summary>

```
N = ln(CL/Cin) / ln(f)
  = ln(10000 fF / 2 fF) / ln(2.72)
  = ln(5000) / 1.0
  = 8.52 / 1.0
  ≈ 8.5 → 取 9 級
```

每級尺寸（以倍數表示）：
```
級 1: 1 (2 fF)
級 2: e¹ ≈ 2.72 (5.4 fF)
級 3: e² ≈ 7.39 (14.8 fF)
級 4: e³ ≈ 20.1 (40.2 fF)
級 5: e⁴ ≈ 54.6 (109 fF)
級 6: e⁵ ≈ 148 (297 fF)
級 7: e⁶ ≈ 403 (806 fF)
級 8: e⁷ ≈ 1097 (2.19 pF)
級 9: e⁸ ≈ 2981 (5.96 pF)
```

需要 **9 級**緩衝器。實務上可能用 f = 4 來減少級數（雖然每級不是最佳，但總延遲差不多）。
</details>

---

> **下一章預告**：第五章將學習**時序電路的 CMOS 實現**——鎖存器、正反器、以及至關重要的 Setup/Hold Time 分析。
