# VLSI 教學講義 第二章：CMOS 反相器動態特性與功率

> **適用對象**：零基礎入門，電機/電子系大學部至研究所
> **重要度**：延遲與功率分析是 IC 設計面試的核心必考題

---

## 🔰 本章基礎觀念（零基礎必讀）

### 為什麼要關心「速度」和「功率」？

上一章我們知道 CMOS 反相器能做邏輯運算，但實際設計時，最被問到的兩個問題是：

1. **它有多快？**（延遲 Delay）→ 決定晶片的最高工作頻率
2. **它耗多少電？**（功率 Power）→ 決定電池壽命、散熱需求

> **黃金公式預覽**：
> - 延遲：tpd ≈ 0.69 · Req · CL
> - 動態功率：Pdyn = α · CL · VDD² · f
> - 能量-延遲積：EDP = Energy × Delay（越小越好）

---

## 一、傳播延遲（Propagation Delay）

### 1.1 定義

傳播延遲衡量的是：**輸入改變後，輸出何時跟上？**

```
Vin  ┌─────────┐
     │         │
─────┘         └─────────

           tpHL     tpLH
           ←──→     ←──→

Vout         ┌─────────┐
             │         │
─────────────┘         └──

     量測點：50% VDD
```

| 符號 | 定義 | 物理意義 |
|------|------|---------|
| tpHL | 輸出從高到低的傳播延遲 | NMOS 放電時間（Vin: 0→VDD） |
| tpLH | 輸出從低到高的傳播延遲 | PMOS 充電時間（Vin: VDD→0） |
| tpd | 平均傳播延遲 | tpd = (tpHL + tpLH) / 2 |

> **重要**：延遲量測從輸入的 50% VDD 到輸出的 50% VDD

### 1.2 延遲的 RC 模型

將電晶體視為一個**等效電阻（Req）**，負載視為**電容（CL）**：

```
          Req
Vout ────┤████├──── VDD (充電) 或 GND (放電)
          │
         ═══ CL
          │
         GND
```

**RC 充放電公式**：

```
Vout(t) = VDD · (1 - e^(-t/(Req·CL)))   [充電]
Vout(t) = VDD · e^(-t/(Req·CL))          [放電]
```

**50% 點的延遲**：

```
tp = ln(2) · Req · CL = 0.693 · Req · CL ≈ 0.69 · Req · CL
```

### 1.3 tpHL 和 tpLH

#### tpHL：NMOS 放電

輸入從 0 → VDD，NMOS 導通，將 CL 上的電荷放到 GND。

```
tpHL ≈ 0.69 · Rn · CL
```

其中 Rn 是 NMOS 的等效電阻。

#### tpLH：PMOS 充電

輸入從 VDD → 0，PMOS 導通，將 VDD 的電荷充到 CL。

```
tpLH ≈ 0.69 · Rp · CL
```

其中 Rp 是 PMOS 的等效電阻。

#### 平均延遲

```
tpd = (tpHL + tpLH) / 2 = 0.69 · CL · (Rn + Rp) / 2
```

### 1.4 等效電阻 Req 計算

等效電阻與**電晶體尺寸成反比**：

```
Req ∝ 1 / (μ · Cox · (W/L) · (VDD - Vt))
```

**簡化模型**（常用於手算）：

| 電晶體 | 等效電阻 |
|--------|---------|
| NMOS (Wn/Ln = 1) | Rn ≈ 12 kΩ（典型值，依製程而異） |
| PMOS (Wp/Lp = 1) | Rp ≈ 30 kΩ（約為 Rn 的 2.5 倍） |

**尺寸縮放**：如果 W/L 變為 k 倍，電阻變為 1/k 倍。

```
Req(W/L = k) = Req(W/L = 1) / k
```

### 1.5 使 tpHL = tpLH 的條件

要讓上升和下降延遲相等：

```
tpHL = tpLH
⟹ Rn · CL = Rp · CL
⟹ Rn = Rp
⟹ μn(Wn/Ln) = μp(Wp/Lp)
⟹ Wp/Lp = (μn/μp) · (Wn/Ln)
```

> **和上一章的結論一致**：對稱反相器需要 Wp ≈ 2~3 × Wn

---

## 二、負載電容 CL 的組成

CL 是決定延遲的**最重要參數之一**，它由以下三部分組成：

```
CL = Cgate + Cdiff + Cwire
```

### 2.1 閘極電容 Cgate（Gate Capacitance）

下一級閘極的輸入電容：

```
Cgate = Cox · W · L
```

其中 Cox 是單位面積閘極氧化層電容。

**扇出（Fan-out）**：如果驅動 N 個相同大小的反相器，Cgate 變 N 倍。

### 2.2 擴散電容 Cdiff（Diffusion Capacitance）

電晶體汲極/源極的 PN 接面電容。

```
Cdiff = Cj · AD + Cjsw · PD
```

其中：
- Cj：單位面積接面電容
- AD：汲極面積
- Cjsw：側壁電容
- PD：汲極周長

### 2.3 互連電容 Cwire（Wire Capacitance）

金屬連線到基板和其他金屬線的電容：

```
Cwire = Cplate + Cfringe + Ccouple
```

在先進製程中，**互連電容可能占 CL 的 50% 以上**。

### 2.4 各成分的相對大小

| 場景 | 主要電容 |
|------|---------|
| 短距離連線、高扇出 | Cgate 為主 |
| 長距離連線 | Cwire 為主 |
| 局部連線 | Cdiff 可能顯著 |

---

## 三、上升時間與下降時間

### 3.1 定義

```
         VDD ┤ ─ ─ ─ ─ ─ ─ ─ ─ ┐
  90% VDD ┤ · · ·┌─ ─ ─ ─ ─ ┘
             │    │
  10% VDD ┤ · ·┌┘
       0  ┤────┘
              ←──→
               tr (上升時間)
```

| 參數 | 定義 | 量測範圍 |
|------|------|---------|
| tr（Rise Time） | 輸出從 10% 到 90% VDD 的時間 | 上升沿 |
| tf（Fall Time） | 輸出從 90% 到 10% VDD 的時間 | 下降沿 |

### 3.2 與 RC 常數的關係

對於一階 RC 電路：

```
tr ≈ 2.2 · Rp · CL    （PMOS 充電）
tf ≈ 2.2 · Rn · CL    （NMOS 放電）
```

> **注意**：上升/下降時間的係數是 2.2（而非 0.69），因為量測範圍是 10%~90%

---

## 四、功率消耗三部曲

### 4.1 總功率

```
Ptotal = Pdynamic + Pshort-circuit + Pstatic
```

### 4.2 動態功率 Pdyn（Dynamic Power）

**這是傳統 CMOS 電路的主要功耗來源。**

每次輸出從 0 → VDD：
- CL 從 GND 充電到 VDD
- 從電源取得能量：E_supply = CL · VDD²
- 儲存在 CL 的能量：E_cap = CL · VDD² / 2
- **另一半能量耗散在 PMOS 的電阻上**

每次輸出從 VDD → 0：
- CL 上的能量 CL · VDD² / 2 全部耗散在 NMOS 的電阻上

所以**每個完整切換週期**消耗的能量：

```
E_switch = CL · VDD²
```

**動態功率公式**：

```
┌─────────────────────────────┐
│  Pdyn = α · CL · VDD² · f  │
└─────────────────────────────┘
```

| 參數 | 意義 | 典型值 |
|------|------|--------|
| α | 切換活動因子（Activity Factor） | 0.1~0.3（平均） |
| CL | 負載電容 | fF 等級 |
| VDD | 電源電壓 | 0.7~1.2V（先進製程） |
| f | 時脈頻率 | GHz 等級 |

> **α 的意義**：不是每個時脈週期都會切換。α = 0.5 代表平均每兩個週期切換一次。
> 對於時脈信號，α = 1（每個週期都切換）。

### 4.3 短路功率 Psc（Short-Circuit Power）

在輸入切換過程中，有一小段時間 **NMOS 和 PMOS 同時導通**：

```
Vin
  ^
VDD┤        ┌─────
   │       ╱
   │      ╱  ← 在此區間，Vtn < Vin < VDD-|Vtp|
   │     ╱     兩個電晶體都導通！
  0┤────╱
   └──────────→ t
```

短路電流路徑：VDD → PMOS → NMOS → GND

```
Psc ≈ (β/12) · (VDD - 2Vt)³ · tr · f
```

**減少短路功率的方法**：
- 使輸入的上升/下降時間**盡量短**（快速通過過渡區）
- 使 Vt 接近 VDD/2（但會影響速度）

> **通常 Psc 占 Pdyn 的 10%~15%**

### 4.4 靜態功率 Pstatic（Static/Leakage Power）

即使電路不切換，仍有漏電流：

```
┌────────────────────────┐
│  Pstatic = Ileak · VDD │
└────────────────────────┘
```

漏電流的主要來源：

| 漏電類型 | 機制 | 重要性 |
|---------|------|--------|
| 次閾值漏電（Subthreshold Leakage） | VGS < Vt 時的弱反轉電流 | **先進製程最大來源** |
| 閘極漏電（Gate Leakage） | 閘極氧化層太薄→穿隧電流 | High-k 介質可改善 |
| 接面漏電（Junction Leakage） | PN 接面的反向漏電 | 較小 |
| GIDL（Gate-Induced Drain Leakage） | 閘極引起的汲極漏電 | 特定偏壓下重要 |

**次閾值漏電公式**：

```
Isub ∝ e^(VGS - Vt) / (n·VT)
```

其中 VT = kT/q ≈ 26mV（室溫）

> **關鍵趨勢**：隨著製程縮小（Vt 降低），漏電呈**指數增長**。
> 在 7nm 以下製程，Pstatic 可能占總功率的 **30%~50%**。

### 4.5 功率組成比較

| 製程世代 | Pdyn 佔比 | Psc 佔比 | Pstatic 佔比 |
|---------|----------|---------|-------------|
| 180nm | ~80% | ~10% | ~10% |
| 65nm | ~60% | ~10% | ~30% |
| 7nm | ~40% | ~5% | ~55% |

---

## 五、能量-延遲積（Energy-Delay Product, EDP）

### 5.1 為什麼需要 EDP？

**功率和速度是矛盾的**：降低 VDD 可以省電，但會變慢。EDP 提供了一個**綜合衡量指標**。

```
Energy = Ptotal / f = α · CL · VDD²    （每次切換的能量）
Delay = tpd ∝ CL · VDD / (VDD - Vt)²

EDP = Energy × Delay
```

**EDP 越小越好**，代表在能量和速度之間取得更好的平衡。

### 5.2 最佳 VDD

對 EDP 求導，可以找到最佳的 VDD（大約在 3~4 倍的 Vt 附近）。

---

## 六、關鍵術語表

| 英文 | 中文 | 說明 |
|------|------|------|
| Propagation Delay (tpd) | 傳播延遲 | 輸入 50% 到輸出 50% 的時間 |
| tpHL | 高到低延遲 | NMOS 放電時間 |
| tpLH | 低到高延遲 | PMOS 充電時間 |
| Rise Time (tr) | 上升時間 | 10% → 90% VDD |
| Fall Time (tf) | 下降時間 | 90% → 10% VDD |
| Equivalent Resistance (Req) | 等效電阻 | 電晶體導通的等效 R |
| Load Capacitance (CL) | 負載電容 | 驅動的總電容 |
| Gate Capacitance | 閘極電容 | 下一級的輸入電容 |
| Diffusion Capacitance | 擴散電容 | PN 接面電容 |
| Wire Capacitance | 互連電容 | 金屬線電容 |
| Dynamic Power | 動態功率 | α·CL·VDD²·f |
| Activity Factor (α) | 切換活動因子 | 切換的機率 |
| Short-Circuit Power | 短路功率 | NMOS/PMOS 同時導通 |
| Leakage Power | 漏電功率 | Ileak·VDD |
| Subthreshold Leakage | 次閾值漏電 | VGS < Vt 的弱反轉電流 |
| Energy-Delay Product (EDP) | 能量延遲積 | 綜合效能指標 |
| Fan-out | 扇出 | 驅動的閘極數量 |

---

## 七、數值例題

### 例題 1：傳播延遲計算

**題目**：一個 CMOS 反相器，Rn = 10 kΩ，Rp = 25 kΩ，CL = 50 fF。求 tpHL、tpLH、tpd。

**解答**：

```
tpHL = 0.69 × Rn × CL
     = 0.69 × 10×10³ × 50×10⁻¹⁵
     = 0.69 × 500 × 10⁻¹²
     = 345 ps

tpLH = 0.69 × Rp × CL
     = 0.69 × 25×10³ × 50×10⁻¹⁵
     = 0.69 × 1250 × 10⁻¹²
     = 862.5 ps

tpd = (tpHL + tpLH) / 2
    = (345 + 862.5) / 2
    = 603.75 ps ≈ 604 ps
```

**答：tpHL = 345 ps，tpLH = 863 ps，tpd ≈ 604 ps**

> 觀察：tpLH >> tpHL，因為 Rp >> Rn。要使延遲對稱，需增大 PMOS 的 W/L。

---

### 例題 2：等效電阻的尺寸縮放

**題目**：某製程中，最小尺寸 NMOS（W/L = 1）的等效電阻 Rn0 = 13 kΩ。
(a) 若 Wn/Ln = 4，Rn = ?
(b) 若 PMOS 最小尺寸的 Rp0 = 31 kΩ，要使 Rp = Rn（使 tpHL = tpLH），Wp/Lp = ?（假設 Wn/Ln = 2）

**解答**：

(a)
```
Rn = Rn0 / (Wn/Ln) = 13k / 4 = 3.25 kΩ
```

(b)
```
目標：Rp = Rn
Rn = 13k / 2 = 6.5 kΩ
Rp = 31k / (Wp/Lp) = 6.5k
Wp/Lp = 31k / 6.5k = 4.77 ≈ 5
```

**答：(a) 3.25 kΩ (b) Wp/Lp ≈ 5**

---

### 例題 3：動態功率計算

**題目**：一顆處理器晶片有 10 億個閘極，平均每個閘極的負載電容 CL = 5 fF，切換活動因子 α = 0.15，VDD = 0.9V，工作頻率 f = 3 GHz。求動態功率。

**解答**：

```
Pdyn = N × α × CL × VDD² × f
     = 10⁹ × 0.15 × 5×10⁻¹⁵ × (0.9)² × 3×10⁹
     = 10⁹ × 0.15 × 5×10⁻¹⁵ × 0.81 × 3×10⁹
```

逐步計算：
```
= 10⁹ × 0.15 × 5 × 0.81 × 3 × 10⁻¹⁵ × 10⁹
= 10⁹ × 1.8225 × 10⁻⁶
= 1.8225 × 10³
≈ 1.82 W...

等等，讓我重新整理：
N × α × CL = 10⁹ × 0.15 × 5×10⁻¹⁵ = 7.5 × 10⁻⁷ F = 750 nF
VDD² = 0.81 V²
f = 3 × 10⁹ Hz

Pdyn = 750×10⁻⁹ × 0.81 × 3×10⁹
     = 750 × 0.81 × 3 × 10⁻⁹⁺⁹
     = 1822.5 W??
```

> 這太高了！讓我重新檢查...

```
α × CL(每個閘) = 0.15 × 5×10⁻¹⁵ = 7.5 × 10⁻¹⁶ F
每個閘的動態功率 = 7.5×10⁻¹⁶ × 0.81 × 3×10⁹ = 1.8225 × 10⁻⁶ W
10⁹ 個閘總功率 = 1.8225 × 10⁻⁶ × 10⁹ = 1822.5 W
```

> 這個結果確實很大！但在 10 億閘級的高頻處理器中是合理的量級。實際上，
> 現代處理器通常只有部分電路同時活動，且有各種省電機制。
> 以 α = 0.15 來說已經是偏高的估計。實際晶片設計會分區域控制功率。

修正為更合理的例題：

**修正題目**：一個小型數位模組有 10 萬個閘極，CL = 5 fF，α = 0.15，VDD = 0.9V，f = 1 GHz。

```
Pdyn = 10⁵ × 0.15 × 5×10⁻¹⁵ × 0.81 × 10⁹
     = 10⁵ × 6.075 × 10⁻⁷
     = 6.075 × 10⁻² W
     ≈ 60.75 mW
```

**答：Pdyn ≈ 60.75 mW**

---

### 例題 4：降低 VDD 的省電效果

**題目**：原設計 VDD = 1.0V，若降至 0.7V，動態功率變為原來的幾倍？

**解答**：

```
Pdyn ∝ VDD²

P_new / P_old = (0.7)² / (1.0)² = 0.49 / 1.0 = 0.49
```

**答：動態功率降為原來的 49%，節省了 51% 的動態功率。**

> 這就是為什麼**電壓縮放（Voltage Scaling）** 是最有效的省電手段！
> 但注意：降低 VDD 也會使延遲增大（速度變慢）。

---

### 例題 5：漏電功率估算

**題目**：一顆晶片在待機時，每個電晶體的平均漏電流 Ileak = 10 nA，共有 5 億個電晶體，VDD = 1.0V。求待機漏電功率。

**解答**：

```
Pstatic = N × Ileak × VDD
        = 5×10⁸ × 10×10⁻⁹ × 1.0
        = 5×10⁸ × 10⁻⁸
        = 5 W
```

**答：待機漏電功率 = 5W**

> 這是很可觀的數字！這就是為什麼先進製程需要使用電源閘控（Power Gating）
> 來切斷不使用模組的電源。

---

### 例題 6：EDP 比較

**題目**：方案 A：VDD = 1.0V，tpd = 50 ps。方案 B：VDD = 0.8V，tpd = 80 ps。
CL 和 α 相同。哪個方案的 EDP 較佳？

**解答**：

```
EDP_A = (α·CL·VDD_A²) × tpd_A = α·CL × 1.0² × 50 = 50·α·CL
EDP_B = (α·CL·VDD_B²) × tpd_B = α·CL × 0.64 × 80 = 51.2·α·CL
```

```
EDP_A / EDP_B = 50 / 51.2 = 0.976
```

**答：方案 A 的 EDP 略佳（小 2.4%），兩者幾乎相同。**

> 方案 B 雖然省電（功率降 36%），但速度慢了 60%，從 EDP 角度看兩者差不多。
> 選擇哪個取決於應用：手機選 B（省電優先），伺服器選 A（速度優先）。

---

## 八、題型鑑別表

| 題目特徵 | 題型 | 關鍵公式 |
|---------|------|---------|
| 給 Rn、Rp、CL | 延遲計算 | tp = 0.69·R·CL |
| 給 W/L，問等效電阻 | 電阻縮放 | R ∝ 1/(W/L) |
| 給 α、CL、VDD、f | 動態功率 | Pdyn = α·CL·VDD²·f |
| 比較不同 VDD | 功率/速度權衡 | P ∝ VDD², tp ∝ VDD/(VDD-Vt)² |
| 給漏電流，求功率 | 靜態功率 | Pstatic = Ileak·VDD |
| 比較兩方案 | EDP 分析 | EDP = E·tp |
| 給 CL 組成 | 電容分析 | CL = Cgate + Cdiff + Cwire |
| 問 tr/tf | 上升/下降時間 | tr = 2.2·R·CL |

---

## ✅ 自我檢測

### Q1：為什麼 tpd = 0.69·Req·CL 中的係數是 0.69？

<details>
<summary>點擊展開答案</summary>

0.69 = ln(2) ≈ 0.693

這來自 RC 電路的指數充放電公式。我們量測的是輸出達到 50% VDD 的時間：

- 放電：VDD · e^(-t/RC) = VDD/2 → t = RC · ln(2)
- 充電：VDD · (1 - e^(-t/RC)) = VDD/2 → t = RC · ln(2)

所以 tp = ln(2) · RC ≈ 0.69 · RC
</details>

### Q2：如果將 VDD 從 1.2V 降到 0.9V，動態功率變化多少？延遲會怎樣？

<details>
<summary>點擊展開答案</summary>

**動態功率**：
Pdyn ∝ VDD² → P_new/P_old = (0.9/1.2)² = 0.5625
動態功率降為原來的 56.25%，**節省 43.75%**。

**延遲**：
tpd ∝ CL·VDD / (VDD - Vt)²

假設 Vt = 0.3V：
- 原來：tpd ∝ 1.2/(1.2-0.3)² = 1.2/0.81 = 1.48
- 新的：tpd ∝ 0.9/(0.9-0.3)² = 0.9/0.36 = 2.5

延遲增大為原來的 2.5/1.48 = 1.69 倍，**慢了約 69%**。

結論：降壓省電效果顯著，但速度代價也很大，需要權衡。
</details>

### Q3：在 7nm 製程中，為什麼漏電功率成為主要功耗來源？

<details>
<summary>點擊展開答案</summary>

原因有多個：

1. **Vt 降低**：為維持速度，閾值電壓隨製程縮小而降低，但次閾值漏電與 Vt 成指數關係（Isub ∝ e^(-Vt/(n·VT))），Vt 每降低 60~100mV，漏電增加約 10 倍。

2. **閘極氧化層變薄**：在 High-k 技術出現前，氧化層薄到幾個原子層，直接穿隧電流（閘極漏電）變得顯著。

3. **DIBL 效應**：短通道效應使 Vt 進一步降低。

4. **電晶體數量增加**：即使每個電晶體漏電很小，數十億個累加起來也很可觀。

5. **VDD 降低幅度有限**：VDD 不能無限降低（受 Vt 限制），所以動態功率的降低趕不上漏電的增加。
</details>

### Q4：切換活動因子 α 為何通常小於 1？舉例說明。

<details>
<summary>點擊展開答案</summary>

α 代表每個時脈週期中，節點發生切換（0→1 或 1→0）的機率。

- **時脈信號**：α = 1（每個週期都切換一次）
- **隨機資料（50% 機率為 0 或 1）**：α = 0.5（根據統計，平均每兩個週期切換一次）
- **大部分邏輯電路**：α ≈ 0.1~0.3（很多節點在多數時脈週期不切換）
- **記憶體（讀取時）**：α 可能很低（只有被存取的位元才切換）

所以在整個晶片平均來看，α 通常遠小於 1，這也是為什麼時脈樹（Clock Tree）是晶片中最大的功耗來源之一（因為時脈的 α = 1）。
</details>

### Q5：請解釋為什麼上升/下降時間的係數是 2.2 而非 0.69？

<details>
<summary>點擊展開答案</summary>

兩者的差別在於**量測範圍不同**：

- **傳播延遲 tp**：量測 0% → 50%（或 100% → 50%）
  - tp = RC · ln(2) = 0.693 · RC

- **上升/下降時間 tr/tf**：量測 10% → 90%（或 90% → 10%）
  - 到達 10%：t₁ = RC · ln(1/0.9) = 0.105 · RC
  - 到達 90%：t₂ = RC · ln(1/0.1) = 2.303 · RC
  - tr = t₂ - t₁ = (2.303 - 0.105) · RC = 2.197 · RC ≈ 2.2 · RC

所以 tr/tf 的係數約是 tp 的 2.2/0.69 ≈ 3.2 倍。
</details>

---

> **下一章預告**：第三章將學習如何用 CMOS 設計各種**組合邏輯閘**（NAND、NOR、AOI 等），
> 以及電晶體尺寸設計和邏輯效能（Logical Effort）方法。
