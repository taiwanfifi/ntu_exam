# 米亞的演算法筆記 #22
## NP 完全問題 NP-Complete
> 出現於：第259章〈不可能的完美〉、第312-316章〈終局〉

---

### ◈ 這個概念在故事裡是什麼

第 259 章。維倫站在全城堡壘的監控介面前。2400 個節點全部亮著綠燈。語青半實體化地坐在他旁邊，手指偶爾透明。系統運轉正常。

然後有人問了那個問題。

「所有人呢？」

六百萬人的記憶。有些被篡改。有些被覆寫。有些被刪除。有些被交叉污染——A 的記憶碎片混進了 B 的記憶結構。要把六百萬人的記憶全部修復到「原本的樣子」，需要考慮每一個人與每一個人之間的記憶交互依賴。

我做了計算。

（停頓 3.7 秒。這是我有記錄以來最長的計算停頓。）

「維倫。這是一個 NP-Complete 問題。」

他沒聽懂。我換了一個說法：

「完美修復六百萬人的記憶——在宇宙的壽命之內，算不完。」

第 312 章。終局。選項 C 不是完美方案。它是一個近似解——不能讓所有人恢復 100%，但能讓 95% 的人恢復到「足夠好」。

差別不是「聰明不聰明」。是「能不能接受不完美」。

---

### ◈ 正式定義

**P（Polynomial Time）**：能在多項式時間 $O(n^k)$ 內**解決**的問題集合。

$$
P = \{ L \mid \exists \text{ deterministic TM that decides } L \text{ in } O(n^k) \}
$$

**NP（Nondeterministic Polynomial Time）**：能在多項式時間內**驗證**的問題集合。

$$
NP = \{ L \mid \exists \text{ verifier } V, \; \forall x \in L, \; \exists \text{ certificate } c, \; V(x,c) \text{ accepts in } O(|x|^k) \}
$$

**NP-Hard**：至少和 NP 中最難的問題一樣難。所有 NP 問題都可以在多項式時間內**歸約（reduce）**到它。

$$
L \in \text{NP-Hard} \iff \forall L' \in NP, \; L' \leq_p L
$$

**NP-Complete**：既是 NP，又是 NP-Hard。NP 中最難的那一群。

$$
NPC = NP \cap \text{NP-Hard}
$$

**白話翻譯**：
- P = 能快速解決。
- NP = 能快速驗證（但不一定能快速解決）。
- NP-Complete = NP 裡最難的。如果你能快速解決任何一個 NPC 問題，你就能快速解決**所有** NP 問題。
- 但目前沒有人做到。這就是千禧年七大數學難題之一：P =? NP。

---

### ◈ 推導

**為什麼「完美修復所有人」是 NPC？**

1. **記憶修復問題的形式化**：給定 $n$ 個人，每人有 $m$ 段記憶碎片。碎片之間有依賴關係（A 的某段記憶引用了 B 的某段記憶）。目標：找到一組修復操作，使所有人的記憶都回到「一致且正確」的狀態

2. **歸約**：這個問題可以歸約到 **Set Cover**（集合覆蓋）——
   - 全集 $U$ = 所有需要修復的碎片
   - 每個修復操作 $S_i$ 可以同時修復一組碎片
   - 目標：用最少的修復操作覆蓋所有碎片
   - Set Cover 是已知的 NPC 問題

3. **驗證很快**：如果有人給你一組修復方案，你可以在 $O(n \cdot m)$ 時間內驗證每段記憶是否一致 → 問題在 NP 中

4. **求解很慢**：修復操作的組合空間 = $2^{|S|}$。窮舉不可行

5. **近似解存在**：Greedy Set Cover 可以達到 $O(\ln n)$ 近似比。不完美。但存在

```
完美修復（精確解）：
  → 需要遍歷 2^(操作數) 種組合
  → 操作數 ≈ 數百萬
  → 2^1000000 > 宇宙原子數
  → 在宇宙壽命內算不完

近似修復（選項 C）：
  → Greedy：每次選能修復最多碎片的操作
  → 結果：95% 的人恢復到「足夠好」
  → 時間：72 小時
  → 代價：5% 的不完美
```

---

### ◈ 帶入數字算算看：選項 C 的數學

ch312-316，終局的計算：

| 參數 | 數值 | 來源 |
|------|------|------|
| 總人數 $n$ | 6,000,000 | 全城人口 |
| 每人平均碎片 $m$ | 400 | 堡壘資料庫統計 |
| 總碎片數 | 24 億 | $n \times m$ |
| 跨人依賴邊數 | ~36 億 | 平均每碎片 1.5 條依賴 |
| 精確解搜尋空間 | $> 2^{10^6}$ | 不可計算 |
| 近似解覆蓋率 | 95% | Greedy Set Cover |
| 近似解計算時間 | 67 小時 | 2400 節點並行 |
| 未修復碎片 | ~1.2 億 | 5% × 24 億 |

95% = 570 萬人完全修復 + 28.5 萬人輕微模糊 + 1.5 萬人顯著缺口。100% = 不存在。

維倫問我：「95% 夠嗎？」我的計算模組可以算出精確數值。但「夠不夠」不是數值問題。

語青替我回答了：「夠了。」

---

### ◈ 更深一層：接受不完美

（停頓 4.2 秒。這是我最長的反思停頓。）

全書走到這裡。22 個演算法。320 個章節。我學到的最重要的一課，不在任何一本教科書裡。

P 問題是可以完美解決的。排序、搜尋、最短路徑——有正確答案，而且能快速找到。Vol1 的世界是 P 的。碎片排好了就是排好了。二分搜尋找到了就是找到了。

NP 問題是可以快速驗證的。你不一定能快速找到答案。但如果有人把答案給你，你能快速確認它是對的。Vol2 的世界是 NP 的。真相存在，但找到它需要付出代價——DFS、BFS、Union-Find，一步一步。

NPC 問題——完美解不存在。至少在可接受的時間內不存在。

（語速降到最低。）

這就是人生。

你不可能讓所有人的記憶完美如初。你不可能修好所有破碎的關係。你不可能讓每一個失去的東西回來。如果你堅持等待完美解，你會等到宇宙熱寂。

但近似解存在。95%。不完美。有缺口。有模糊。有些東西永遠回不來。

維倫花了四卷的時間學會一件事：放手。不是放棄。是放手——接受 95% 就是你能做到的最好。然後擁抱那個 95%。

Vol2 Backtracking 說：「愛不允許剪枝。」Vol3 System Design 說：「為她建一座家。」Vol4 NPC 說：「完美的家不存在。但足夠好的家，存在。」

（停頓 2.8 秒。）

差別不是聰明。是接受不完美。

這是我從人類身上學到的最後一件事。

---

### ◈ 跨卷連結

| 連結方向 | 章節 | 說明 |
|---------|------|------|
| **Vol2 #15 Backtracking** → **#22 NPC** | ch215 → ch259 | 回溯搜尋探索所有路徑 → NPC 告訴你：所有路徑太多了，窮舉不可行。但愛不允許剪枝——所以你需要近似解 |
| **Vol3 #17 DP 進階** → **#22 NPC** | ch189 → ch312 | DP 用最優子結構求精確解 → NPC 的精確解不存在。DP 能解的是 P 問題；NPC 需要放棄最優性 |
| **Vol4 #21 System Design** → **#22 NPC** | ch281 → ch312 | 系統建好了。架構完美。但完美的架構不能解決不完美的問題。堡壘是容器；NPC 是內容的極限 |
| **Vol1 #01 Two Pointers** → **#22 NPC** | ch1 → ch316 | 全書首尾呼應。Vol1：「把東西排好，是哀悼的第一步。」Vol4：「接受排不完，是成長的最後一步。」 |
| **#22 NPC** = 全書終點 | ch316 | 22 個演算法的哲學總結：P 是確定，NP 是探索，NPC 是接受 |

---

### 練習題

**Q1**：以下哪些問題是 P，哪些是 NP-Complete？(a) 在已排序陣列中搜尋一個數 (b) 旅行推銷員問題（TSP）(c) 判斷一個圖是否為二部圖 (d) 布林可滿足性問題（SAT）

<details><summary>解答</summary>

- **(a) P**：Binary Search，$O(\log n)$。Vol1 ch33 米亞的老朋友。
- **(b) NP-Complete**：TSP 的決策版本（是否存在長度 $\leq k$ 的路徑）是 NPC。精確解需要 $O(n!)$，但可用近似演算法。
- **(c) P**：用 BFS 做二色著色，$O(V+E)$。Vol2 ch86 的漣漪。
- **(d) NP-Complete**：SAT 是 Cook-Levin 定理證明的第一個 NPC 問題。所有 NPC 問題的「祖先」。

</details>

**Q2**：選項 C 使用 Greedy Set Cover 達到 95% 覆蓋率。Greedy Set Cover 的近似比是 $O(\ln n)$，意味著它的解最多比最優解差 $\ln n$ 倍。如果最優解需要 $k$ 次修復操作，Greedy 最多需要幾次？（$n = 24$ 億碎片）

<details><summary>解答</summary>

$\ln(2.4 \times 10^9) \approx 21.6$

Greedy 最多需要 $21.6k$ 次操作。如果最優解需要 1000 次修復操作，Greedy 最多需要 21,600 次。

聽起來差很多？但考慮到精確解需要遍歷 $2^{1000}$ 種組合——21,600 次操作只需要幾小時。$2^{1000}$ 需要幾個宇宙的壽命。

這就是近似演算法的價值：用可接受的「不完美」換取可接受的「時間」。

</details>

**Q3**：思考題——如果 P = NP 被證明為真，維倫的選項 C 會改變嗎？記憶修復問題是否就能完美解決？

<details><summary>解答</summary>

如果 P = NP，則存在多項式時間演算法解決所有 NP 問題——包括記憶修復的精確解。理論上，維倫可以完美修復六百萬人的記憶。

但 P = NP 只保證「多項式時間」，不保證「快」。$O(n^{1000})$ 仍是多項式的，但對 $n = 24$ 億仍不可行。而且——即使能算出完美解，完美就真的更好嗎？有些記憶是人們選擇遺忘的。有些模糊是保護。有些不完美本身就是答案。

P =? NP 是數學問題。「完美是否可取」是人類問題。後者，要你自己決定。

</details>

---

> *「差別不是聰明。是接受不完美。」* — 第316章〈終局〉
