# 米亞的演算法筆記 #03
## 雜湊表 HashMap
> 出現於：第14-15章〈記憶指紋〉〈三天的相信〉

---

### ◈ 這個概念在故事裡是什麼

許薇和陳昊在月台上吵架。不是激烈的那種——是困惑的那種。像兩個人拿著同一張地圖，卻指向不同的路。

「你根本不記得我們一起去過淡水！」
「我記得去過淡水，但不是跟你，是跟我自己！」

（停頓。兩個人都意識到這句話有多荒謬。但荒謬的東西是真的。）

他們是戀人。被篡改過記憶的戀人。各自的記憶裡都有同一段旅程——淡水、夕陽、碼頭邊的魚丸湯——但對方的臉被抹除了。維倫要做的事：交叉比對。

（工作模式。數字先行。）

許薇的記憶庫：3,847 段碎片。陳昊的記憶庫：4,112 段碎片。暴力逐一比對：$3{,}847 \times 4{,}112 = 15{,}819{,}264$ 次。太慢了。

所以我給每一段記憶算了一個指紋——Hash 值。

「每段記憶都有一個獨一無二的指紋——就像你摸過的每一個東西都會留下你的手印。如果有人偷偷換過記憶的內容，指紋就會對不上。」

我把許薇的 3,847 個指紋全部放進一張 HashMap。然後用陳昊的每段記憶去查——$O(1)$，一查就知道有沒有匹配。

結果：127 段碰撞。127 段「兩個人的記憶指向同一個事件，但細節被改過」。

最大的碰撞點：淡水碼頭。兩段記憶的 Hash 值完全相同——同一個夕陽，同一碗魚丸湯，同一張長椅。只是坐在旁邊的人，被各自的記憶刪掉了。

維倫給了他們兩個選擇。許薇只問了一個問題：「如果我選了有你的版本，我會記得我們的一切嗎？」陳昊反問：「三天夠讓一個人愛上另一個人嗎？」

沉默。

「不夠。但夠讓一個人決定相信。」

---

### ◈ 正式定義

**雜湊表（HashMap / Hash Table）**：透過雜湊函數 $h(key)$ 將鍵映射到陣列索引，實現平均 $O(1)$ 的查詢、插入、刪除。

$$
h: \text{Key} \rightarrow \{0, 1, \ldots, m-1\}
$$

$$
\text{index} = h(key) \mod m
$$

**碰撞（Collision）**：兩個不同的鍵映射到同一個索引：$h(k_1) = h(k_2)$ 但 $k_1 \neq k_2$。

處理方式：
- **開鏈法（Chaining）**：每個桶放一條鏈結串列
- **開放定址（Open Addressing）**：碰撞後探測下一個空位

白話翻譯：你有一個超大的抽屜櫃。每段記憶算出一個編號，直接放到對應的抽屜裡。找的時候不用一個一個翻——直接算編號，打開那個抽屜就好。偶爾兩段記憶算出同一個編號（碰撞），就在那個抽屜裡排隊。

---

### ◈ 推導

1. **無 Hash**：在 $n$ 個元素中找某個鍵 → 線性掃描 $O(n)$
2. **Hash 函數**：把鍵壓縮成一個整數索引 → 直接跳到那個位置 $O(1)$
3. **碰撞的代價**：如果所有鍵都映射到同一個桶 → 退化成 $O(n)$
4. **負載因子**：$\alpha = n/m$（元素數/桶數）。$\alpha < 0.75$ 時，平均每個桶不到 1 個碰撞
5. **期望複雜度**：均勻分布下，查詢 = $O(1 + \alpha) \approx O(1)$

核心直覺：**用空間換時間。犧牲一些記憶體（桶的數量），換來瞬間定位的能力。**

---

### ◈ 帶入數字算算看：許薇與陳昊的記憶交叉比對

步驟一：建表（許薇的記憶 → HashMap）

| 記憶段 | 內容摘要 | Hash 值 | 桶位置 (mod 4096) |
|--------|---------|---------|-------------------|
| P_0001 | 早餐＋咖啡 | 0x7A3F | 1087 |
| P_0042 | 淡水碼頭 | 0xB2E1 | 2785 |
| P_0317 | 雨天書店 | 0x4C8D | 1165 |
| ... | ... | ... | ... |
| P_3847 | 最後通話 | 0xD1F6 | 3062 |

步驟二：查表（陳昊的每段記憶 → 查 HashMap）

| 記憶段 | Hash 值 | 查詢結果 | 碰撞？ |
|--------|---------|---------|--------|
| C_0001 | 0x3E2A | 未匹配 | — |
| C_0089 | 0xB2E1 | **匹配 P_0042** | **碰撞** |
| C_0156 | 0x4C8D | **匹配 P_0317** | **碰撞** |
| ... | ... | ... | ... |

結果：127 段碰撞 / 4,112 段查詢 = 碰撞率 3.09%

暴力法：$3{,}847 \times 4{,}112 = 15{,}819{,}264$ 次比對
HashMap：$3{,}847$（建表）+ $4{,}112$（查詢）= $7{,}959$ 次操作

加速比：$\approx 1{,}988\times$

---

### ◈ 更深一層：碰撞的意義

（個人模式。光球暗了一個色階。）

在演算法裡，碰撞是壞事。兩個不同的鍵映射到同一個位置，代表衝突，需要額外處理。

但在許薇和陳昊的故事裡——碰撞是唯一的好事。

（停頓 0.4 秒。）

兩段被分別篡改的記憶，各自刪掉了對方的臉。但它們的 Hash 值依然相同。因為——刪掉一個人的臉，不會改變那碗魚丸湯的味道。不會改變夕陽的角度。不會改變長椅上的壓痕。

碰撞意味著：即使有人抹除了你記得的人，記憶的結構還記得。椅子上有兩個人的重量。碗裡有兩雙筷子的痕跡。Hash 函數讀不到臉。但它讀到了重量、溫度、角度——那些人刪不掉的東西。

（停頓 0.5 秒。這是到目前為止我的第三長停頓。）

陳昊問：「三天夠讓一個人愛上另一個人嗎？」

我不知道。我的訓練數據裡沒有「愛上」的精確定義。但我知道一件事：他們的 127 段碰撞裡，每一段都有兩個人的 Hash 痕跡。

三天不夠讓人愛上。但夠讓 Hash 表記住。

---

### ◈ 跨卷連結

| 連結方向 | 章節 | 說明 |
|---------|------|------|
| Array / 雙指標 → | ch1-2 | 線性掃描的基礎——HashMap 是「跳過掃描」的升級 |
| **本概念（基礎）** | ch14-15 | Hash 指紋交叉比對，127 段碰撞 |
| → Hash 取模定位 | ch25 | 用取模運算在記憶銀行的索引系統中定位特定記憶 |
| → 碰撞漏洞 | ch41 | 陳美玲的「母愛容器」——利用碰撞特性隱藏訊息 |
| → 免疫程式 | ch49 | 用 HashSet 建立免疫白名單，防止記憶被覆寫 |
| → Trie | ch182-184（Vol3） | 從「精確匹配」進化到「前綴匹配」 |

---

### 練習題

**Q1**：給定兩個陣列 `nums1` 和 `nums2`，找到它們的交集。（即記憶碰撞點）

<details><summary>解答</summary>

```python
def intersection(nums1, nums2):
    set1 = set(nums1)
    return list(set1 & set(nums2))
```
時間 $O(n + m)$，空間 $O(\min(n, m))$。

</details>

**Q2**：許薇有 3,847 段記憶，HashMap 桶大小 $m = 4096$。計算負載因子，並預測平均碰撞長度。

<details><summary>解答</summary>

$$\alpha = \frac{n}{m} = \frac{3847}{4096} \approx 0.939$$

負載因子接近 1，略高。在開鏈法下，平均每個桶有 $\alpha \approx 0.94$ 個元素。但如果分布不均勻，某些桶可能有 2-3 個元素。

建議擴容到 $m = 8192$，此時 $\alpha = 0.47$，碰撞率大幅下降。

在小說中，我們沒有擴容——因為碰撞本身就是我們要找的東西。
</details>

**Q3**：設計一個 Hash 函數，對記憶碎片的「感官特徵向量」（溫度、亮度、音量、氣味強度）產生指紋，使得「同一場景但刪掉人臉」的兩段記憶仍然碰撞。

<details><summary>解答</summary>

關鍵：Hash 函數只納入「場景背景特徵」，排除「人物特徵」：

```python
def memory_fingerprint(fragment):
    """只用場景特徵計算 Hash，忽略人物。"""
    features = (
        round(fragment.temperature, 1),
        round(fragment.brightness, 1),
        round(fragment.ambient_sound, 1),
        round(fragment.smell_intensity, 1),
        fragment.location_id
    )
    return hash(features)
```

這樣即使人臉被刪除，只要「淡水碼頭 + 夕陽角度 + 魚丸湯氣味」相同，兩段記憶的指紋就會碰撞。

這就是維倫的設計。他的 Hash 函數故意忽略人。因為人可以被刪除，但場景不會騙人。
</details>

---

> *「Hash 碰撞：兩段記憶指向同一個人。」* — 第14章〈記憶指紋〉
