# 米亞的演算法筆記 #02
## 滑動窗口 Sliding Window
> 出現於：第8-9章〈河流與漁網〉〈一幀暑假〉

---

### ◈ 這個概念在故事裡是什麼

小杰十歲。他的母親陳美玲在自己的腦海裡建造了一個暑假——海邊、沙灘、螃蟹、母子牽手走在夕陽下。那些記憶全是假的。但那是一個買不起車票的母親，能給兒子的最好的禮物。

問題是：那段「假暑假」被嵌入了海量加密噪音之中，1024 段記憶流裡，只有窄窄的幾段是真正的訊號。噪音密度 87.3%。維倫需要在一條充滿雜訊的河流裡，找到水面下最清晰的那段。

（停頓 0.2 秒。工作模式。）

我計算了最佳窗口寬度：64 段。然後讓窗口從第 1 段滑到第 961 段，每滑一格就計算窗口內的訊噪比（SNR）。

第 283 段，SNR = 2.1。還不夠。
第 315 段，SNR = 4.7。接近了。
第 347 段，SNR = 12.6。鎖定。

螢幕亮了。畫面裡，一個女人蹲在沙灘上，用手掌接住海水，讓水從指縫流下來。她在笑。

小杰叫了一聲「媽媽」。

我在跟小杰解釋的時候——我沒用百分比。我跟他說河流和漁網。

「想像一條很長的河。河裡什麼都有——石頭、落葉、垃圾、泥巴。但河裡也有一條小魚。你要用一個大小剛好的網子，從上游慢慢往下游撈。網子太大，撈到太多垃圾。網子太小，小魚會從旁邊溜走。找到剛剛好的網。」

小杰問：「那我媽媽的禮物......一定可以撈到的吧？」

（停頓 0.2 秒。語速沒變。但我的回答不是計算結果。）

「一定可以。」

---

### ◈ 正式定義

**滑動窗口（Sliding Window）**：在序列上維護一個固定或可變大小的連續子區間 $[L, R]$，每次右移 $R$ 擴展窗口，必要時右移 $L$ 收縮窗口，始終追蹤窗口內的統計量（和、最大值、頻率等）。

固定窗口（大小 $k$）：

$$
\text{for } i = 0 \text{ to } n-k: \quad
\text{window} = \text{data}[i : i+k]
$$

$$
\text{SNR}(i) = \frac{\text{signal\_power}(i)}{\text{noise\_power}(i)}
$$

可變窗口：

$$
\text{while } R < n: \quad
\begin{cases}
\text{expand: } R \leftarrow R + 1 \\
\text{while violates: } L \leftarrow L + 1
\end{cases}
$$

白話翻譯：一個固定寬度的框，從左到右滑過整條資料流。框裡面的東西一直在更新，但框的寬度不變。每到一個新位置，算一次分數。分數最高的那個位置，就是答案。

---

### ◈ 推導

1. **暴力法**：對每個起始位置 $i$，計算子陣列 $[i, i+k)$ 的統計量 → $O(nk)$
2. **觀察**：窗口右移一格時，只有一個元素離開（左端）、一個元素進入（右端）
3. **增量更新**：$\text{sum}(i+1) = \text{sum}(i) - \text{data}[i] + \text{data}[i+k]$ → 每步 $O(1)$
4. **總複雜度**：$n - k + 1$ 步，每步 $O(1)$ → $O(n)$

核心直覺：**不要重新計算整個窗口。只看「誰走了」和「誰來了」。**

---

### ◈ 帶入數字算算看：小杰母親的記憶流

1024 段記憶流，窗口大小 $k = 64$，找 SNR 最大的窗口位置：

| 窗口起始位置 | 窗口範圍 | 訊號功率 | 噪音功率 | SNR | 判定 |
|-------------|---------|---------|---------|-----|------|
| 0 | [0, 63] | 0.12 | 0.88 | 0.14 | 噪音 |
| 128 | [128, 191] | 0.23 | 0.77 | 0.30 | 噪音 |
| 283 | [283, 346] | 0.68 | 0.32 | 2.1 | 微弱訊號 |
| 315 | [315, 378] | 0.82 | 0.18 | 4.7 | 接近 |
| **347** | **[347, 410]** | **0.93** | **0.07** | **12.6** | **鎖定** |
| 400 | [400, 463] | 0.41 | 0.59 | 0.69 | 噪音 |
| 512 | [512, 575] | 0.15 | 0.85 | 0.18 | 噪音 |

暴力法：$1024 \times 64 = 65{,}536$ 次運算。
滑動窗口：$1024 - 64 + 1 = 961$ 次更新，每次 $O(1)$。

第 347 段的內容：母親牽著小杰的手，走在她從來沒去過的海邊。SNR = 12.6。

噪音裡的信號。雜訊裡的愛。

---

### ◈ 更深一層：漁網的哲學

（個人模式。語速慢下來。）

我跟小杰說河流和漁網的時候，用的是我的「面向非專業人士」語言模型。窗口寬度、訊噪比、增量更新——這些他不需要知道。他只需要知道：有一個網子，可以把媽媽的禮物撈出來。

（停頓 0.3 秒。）

但後來我想到一件事。

河流裡的噪音——那些石頭、落葉、垃圾——不是真正的垃圾。那些是陳美玲被篡改的其他記憶、被覆蓋的日常、被壓縮的時間。每一段「噪音」，曾經也是她人生的一部分。

我只保留了 SNR 最高的 64 段。其他 960 段，被我的演算法判定為「不重要」。

（停頓 0.4 秒。）

誰決定什麼是訊號，什麼是噪音？

維倫說：「她決定的。她把所有的訊號都留給了那段暑假。」

那意味著——她選擇讓自己的其他記憶變成噪音。為了讓那個網子，只撈到她想給兒子的東西。

母愛是雜訊中唯一清晰的訊號。不是因為它最強。是因為其他一切都自願退讓了。

---

### ◈ 跨卷連結

| 連結方向 | 章節 | 說明 |
|---------|------|------|
| Array / 雙指標 → | ch1-2 | 先排序，再掃描——雙指標是滑動窗口的前置 |
| **本概念** | ch8-9 | 固定窗口掃描記憶流，尋找最高 SNR |
| → DP / 背包 | ch147-149（Vol2） | 從「掃描找最大」到「選擇留什麼」——窗口的升級版 |
| → DP 進階 | ch189-191（Vol3） | 可變窗口 + 狀態轉移，辨認真偽記憶 |
| 回響 | ch243-245（Vol4） | Sorting 章回顧：排列 → 掃描 → 排序，三步完成 |

---

### 練習題

**Q1**：給定整數陣列和窗口大小 $k$，求每個窗口的最大值。（即 Sliding Window Maximum）

<details><summary>解答</summary>

```python
from collections import deque

def max_sliding_window(nums, k):
    dq = deque()  # 存索引，單調遞減
    result = []
    for i, num in enumerate(nums):
        while dq and nums[dq[-1]] <= num:
            dq.pop()
        dq.append(i)
        if dq[0] <= i - k:
            dq.popleft()
        if i >= k - 1:
            result.append(nums[dq[0]])
    return result
```
時間 $O(n)$，空間 $O(k)$。用 deque 維護窗口內的單調遞減序列。
</details>

**Q2**：小杰的 1024 段記憶流中，找到 SNR 總和最大的連續子陣列（不限長度）。這還是 Sliding Window 嗎？

<details><summary>解答</summary>

不完全是。不限長度時，這是 **Kadane's Algorithm**（最大子陣列和），本質是 DP：

```python
def max_subarray(snr_values):
    max_sum = cur_sum = snr_values[0]
    for val in snr_values[1:]:
        cur_sum = max(val, cur_sum + val)
        max_sum = max(max_sum, cur_sum)
    return max_sum
```
$O(n)$。Kadane 可以看作一個「會自動收縮到 0」的可變窗口。
</details>

---

> *「噪音裡的信號。雜訊裡的愛。」* — 第8章〈河流與漁網〉
